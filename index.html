<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcaDexa - Advanced Scheduling Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; @apply bg-slate-100 text-slate-800 dark:bg-gray-900 dark:text-slate-200; transition: background-color 0.3s; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-color: #f1f5f9;
            background-image: radial-gradient(circle at 1px 1px, #d1d5db 1px, transparent 0);
            background-size: 20px 20px;
            transition: background-color 0.3s;
        }
        .dark body::before {
            background-color: #111827;
            background-image: radial-gradient(circle at 1px 1px, #374151 1px, transparent 0);
        }
        .modal { transition: opacity 0.3s, visibility 0.3s; @apply invisible opacity-0; }
        .modal.visible { @apply visible opacity-100; }
        .modal-content { transition: transform 0.3s; transform: scale(0.95); }
        .modal.visible .modal-content { transform: scale(1); }
        .toast { transition: opacity 0.3s, transform 0.3s; }
        .btn-icon { @apply w-5 h-5; }
        :root { --fc-border-color: #e2e8f0; --fc-neutral-bg-color: rgba(241, 245, 249, 0.5); }
        html.dark { --fc-border-color: #374151; --fc-neutral-bg-color: rgba(31, 41, 55, 0.5); }
        .fc .fc-toolbar-title { @apply text-xl font-bold; }
        .fc .fc-button { @apply bg-indigo-600 border-indigo-600 hover:bg-indigo-700; }
        .fc-event { font-size: 0.75rem; }
        .fc-event.dimmed { @apply opacity-30; }
        .fc-event.absent { @apply opacity-50 line-through; }
        #scanner-animation.scanning .inner-circle { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.7; } 50% { transform: scale(1); opacity: 1; } }

        @media print {
            body * { visibility: hidden; }
            #calendar-container, #calendar-container * { visibility: visible; }
            #schedule-controls, #schedule-controls * { visibility: hidden; }
            #calendar-container { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40 border-b border-slate-200 dark:border-gray-700">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold tracking-wider font-poppins">Aca<span class="text-indigo-500">Dexa</span></div>
            <div class="flex items-center gap-2 sm:gap-4">
                 <button id="notifications-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition relative hidden" title="Notifications"><i data-lucide="bell"></i><span id="notification-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden"></span></button>
                 <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition" title="Toggle Dark Mode"><i data-lucide="moon"></i></button>
                 <div id="auth-container" class="flex items-center gap-2">
                    <button id="student-login-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm">Student Login</button>
                    <button id="staff-portal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm">Staff Portal</button>
                 </div>
                 <div id="user-info-container" class="hidden items-center gap-3">
                    <span id="username-display" class="font-semibold hidden sm:block"></span>
                    <button id="logout-btn" class="p-2 rounded-full bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition" title="Logout"><i data-lucide="log-out" class="btn-icon"></i></button>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto p-4 sm:p-6">
        <div id="welcome-screen">
             <div class="text-center py-24"><h1 class="text-5xl md:text-7xl font-extrabold font-poppins tracking-tight">Welcome to Aca<span class="text-indigo-500">Dexa</span></h1><p class="mt-4 text-lg text-slate-600 dark:text-slate-300">Your all-in-one solution for intelligent academic scheduling.</p><p class="mt-2 text-slate-500">Please log in to access your dashboard and schedule.</p></div>
        </div>
        
        <div id="staff-dashboard" class="hidden"></div>
        <div id="student-dashboard" class="hidden"></div>
        
        <div id="schedule-view" class="hidden mt-6">
            <div class="bg-white dark:bg-gray-800/50 p-4 rounded-xl shadow-md">
                 <div id="schedule-controls" class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <select id="schedule-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                    <div id="staff-schedule-filters" class="flex items-center gap-2">
                        <label for="staff-view-selector" class="text-sm font-medium">View as:</label>
                        <select id="staff-view-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                    </div>
                    <div>
                        <button id="print-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2"><i data-lucide="printer"></i> Print</button>
                        <button id="download-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2"><i data-lucide="download"></i> Download</button>
                    </div>
                </div>
                <div id="calendar-container"></div>
            </div>
        </div>
    </main>

    <button id="ask-ai-btn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg text-2xl z-40 hidden"><i data-lucide="bot" class="w-8 h-8"></i></button>
    <div id="toast" class="toast fixed bottom-6 left-1/2 -translate-x-1/2 bg-red-600 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 z-[90]"><p id="toast-message"></p></div>
    
    <div id="modals-container"></div>
    <script type="text/template" id="modals-template">
        <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-sm w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500"><i data-lucide="x"></i></button><h3 id="login-title" class="text-2xl font-bold mb-6 text-center">Login</h3><form id="auth-form"><div class="space-y-4"><input type="email" id="auth-email" placeholder="Email" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required><input type="password" id="auth-password" placeholder="Password" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div><p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p><button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Login</button></form></div></div>
        <div id="staff-portal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-6 text-center">Staff Portal</h3><div class="flex flex-col gap-4"><a href="#staff-dashboard" id="open-dashboard-btn" class="w-full text-center bg-indigo-600 text-white font-bold py-3 rounded-lg text-lg flex items-center justify-center gap-2"><i data-lucide="layout-dashboard"></i> View Dashboard</a><button id="open-attendance-portal-btn" class="w-full bg-slate-600 text-white font-bold py-3 rounded-lg text-lg flex items-center justify-center gap-2"><i data-lucide="fingerprint"></i> Attendance Portal</button></div></div></div>
        <div id="attendance-portal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-4 text-center">Biometric Attendance Portal</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="text-center"><h4 class="font-bold mb-4">Scan to Verify Presence</h4><div id="scanner-animation" class="w-40 h-40 mx-auto flex items-center justify-center border-4 border-slate-300 dark:border-gray-600 rounded-full p-2"><div class="inner-circle w-32 h-32 bg-indigo-500 rounded-full"></div></div><p id="scanner-status" class="mt-4 h-6 font-semibold"></p><button id="scan-biometric-btn" class="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Scan Fingerprint</button></div><div><h4 class="font-bold mb-4">Live Staff Status (<span id="current-time"></span>)</h4><div id="staff-status-dashboard" class="space-y-2 h-56 overflow-y-auto pr-2"></div></div></div></div></div>
        <div id="class-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500"><i data-lucide="x"></i></button><h3 id="class-modal-title" class="text-2xl font-bold"></h3><p id="class-modal-time" class="text-slate-500 mb-4"></p><div class="space-y-3 border-t pt-4"><div class="flex items-center gap-3"><i data-lucide="user" class="btn-icon"></i><span id="class-modal-prof"></span></div><div class="flex items-center gap-3"><i data-lucide="building" class="btn-icon"></i><span id="class-modal-room"></span></div><div class="flex items-center gap-3"><i data-lucide="star" class="btn-icon"></i><span id="class-modal-credits"></span></div><div id="notes-container" class="border-t pt-3 mt-3"><h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="notebook-text"></i>Lecture Notes</h4><p id="class-modal-notes" class="text-sm p-3 bg-slate-100 dark:bg-gray-700 rounded-md max-h-24 overflow-y-auto"></p></div><div id="action-container" class="mt-4"></div></div></div></div>
        <div id="notifications-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-4">Notifications & Debts</h3><div class="border-b pb-2 mb-2"><h4 class="font-bold flex items-center gap-2"><i data-lucide="arrow-left-right"></i>Pending Class Debts</h4><div id="class-debt-list" class="text-sm"></div></div><div><h4 class="font-bold flex items-center gap-2"><i data-lucide="alert-circle"></i>Alerts</h4><div id="alert-list"></div></div></div></div>
        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-end justify-end p-4 sm:p-6"><div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md h-[70vh] flex flex-col"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="bot"></i> AcaDexi Assistant</h3><button class="close-modal-btn text-slate-500"><i data-lucide="x"></i></button></div><div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col"></div><div class="p-4 border-t dark:border-gray-700"><form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" placeholder="Ask me anything..." class="flex-grow p-2 rounded-md dark:bg-gray-700 border-slate-300 dark:border-gray-600"><button type="submit" class="bg-indigo-600 text-white font-bold px-4 rounded-lg"><i data-lucide="send"></i></button></form></div></div></div>
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, writeBatch, query, where, getDocs, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ⚠️ PASTE YOUR FIREBASE CONFIG HERE ⚠️ ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // --- END OF FIREBASE CONFIG ---

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            document.body.innerHTML = `<div class="p-8 text-center text-red-500"><h1>Configuration Error</h1><p>Please paste your Firebase configuration into the script tag and complete the setup steps.</p></div>`;
        }

        let currentUser = null, calendar = null, activeLoginRole = null;
        let scheduleData = {}, staffList = [], attendanceStatus = {}, classDebts = [];
        let scheduleUnsubscribe = null, attendanceUnsubscribe = null, debtsUnsubscribe = null;
        let workloadChart = null;
        let conversationState = {};

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modals-container').innerHTML = document.getElementById('modals-template').innerHTML;
            lucide.createIcons();
            setupEventListeners();
            initializeCalendar();
            
            onAuthStateChanged(auth, async user => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) {
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        await checkAndSeedDatabase();
                        initializeAppUI();
                    } else { signOut(auth); }
                } else {
                    currentUser = null;
                    initializeAppUI();
                }
            });
        });

        async function initializeAppUI() {
            updateUIForAuthState();
            if (currentUser) {
                await fetchStaffList();
                listenToAttendance();
                listenToDebts();
                if(currentUser.role === 'staff') {
                    showView('staff-dashboard');
                    await renderStaffDashboard();
                } else {
                    showView('student-dashboard');
                    await renderStudentDashboard();
                }
                await populateScheduleSelector();
                const defaultSchedule = currentUser.role === 'student' ? currentUser.scheduleId : 'grade-10-a';
                await loadSchedule(defaultSchedule);
            } else {
                showView('welcome-screen');
                if (scheduleUnsubscribe) scheduleUnsubscribe();
                if (attendanceUnsubscribe) attendanceUnsubscribe();
                if (debtsUnsubscribe) debtsUnsubscribe();
            }
        }
        
        function setupEventListeners() {
            document.getElementById('student-login-btn').onclick = () => openLoginModal('student');
            document.getElementById('staff-portal-btn').onclick = () => showModal('staff-portal-modal');
            document.getElementById('open-dashboard-btn').onclick = () => { hideModal('staff-portal-modal'); showView(currentUser.role === 'staff' ? 'staff-dashboard' : 'student-dashboard'); };
            document.getElementById('open-attendance-portal-btn').onclick = () => { hideModal('staff-portal-modal'); openAttendancePortal(); };
            document.getElementById('logout-btn').onclick = () => signOut(auth);
            document.getElementById('auth-form').onsubmit = handleAuthSubmit;
            document.getElementById('scan-biometric-btn').onclick = handleBiometricScan;
            document.getElementById('ask-ai-btn').onclick = () => showModal('ai-chat-modal');
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
            document.getElementById('notifications-btn').onclick = openNotifications;
            document.getElementById('dark-mode-toggle').onclick = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                document.querySelector('#dark-mode-toggle i').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
                if(workloadChart) renderStaffDashboard();
            };
            document.getElementById('schedule-selector').onchange = (e) => loadSchedule(e.target.value);
            document.getElementById('staff-view-selector').onchange = (e) => filterScheduleByStaff(e.target.value);
            document.getElementById('print-btn').onclick = () => window.print();
            document.addEventListener('click', (e) => {
                 if (e.target.closest('.close-modal-btn')) hideModal(e.target.closest('.modal').id);
            });
        }
        
        // --- AUTHENTICATION ---
        function openLoginModal(role) {
            activeLoginRole = role;
            document.getElementById('login-title').textContent = `${role} Login`;
            showModal('login-modal');
        }
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
                hideModal('login-modal');
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
            }
        }

        // --- UI & VIEW MANAGEMENT ---
        function showView(viewId) {
            ['welcome-screen', 'staff-dashboard', 'student-dashboard', 'schedule-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function updateUIForAuthState() {
            const loggedIn = !!currentUser;
            document.getElementById('auth-container').style.display = loggedIn ? 'none' : 'flex';
            document.getElementById('user-info-container').style.display = loggedIn ? 'flex' : 'none';
            document.getElementById('username-display').textContent = `Welcome, ${currentUser?.fullName || ''}`;
            document.getElementById('ask-ai-btn').style.display = loggedIn ? 'flex' : 'none';
            document.getElementById('notifications-btn').style.display = currentUser?.role === 'staff' ? 'flex' : 'none';
        }

        // --- DATA FETCHING & REAL-TIME LISTENERS ---
        async function fetchStaffList() {
            const q = query(collection(db, "users"), where("role", "==", "staff"));
            const querySnapshot = await getDocs(q);
            staffList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function listenToAttendance() {
            const today = new Date().toISOString().slice(0, 10);
            const attendanceRef = doc(db, "attendance", today);
            if(attendanceUnsubscribe) attendanceUnsubscribe();
            attendanceUnsubscribe = onSnapshot(attendanceRef, (docSnap) => {
                if(docSnap.exists()) {
                    attendanceStatus = docSnap.data();
                } else {
                    staffList.forEach(staff => attendanceStatus[staff.fullName] = "Pending");
                }
            });
        }
        
        function listenToDebts() {
            const q = query(collection(db, "classDebts"), where("status", "==", "Unpaid"));
            if(debtsUnsubscribe) debtsUnsubscribe();
            debtsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                classDebts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }
        
        // --- DASHBOARDS ---
        async function renderStaffDashboard() {
            const dash = document.getElementById('staff-dashboard');
            // ... Logic to render charts and KPIs ...
            dash.innerHTML = `<h2 class="text-3xl font-bold mb-4">Staff Dashboard</h2><div class="bg-white dark:bg-gray-800/50 p-4 rounded-xl shadow-md"><canvas id="workload-chart"></canvas></div>`; // Simplified
            
            const staffWorkload = {};
            staffList.forEach(s => staffWorkload[s.fullName] = 0);
            Object.values(scheduleData).forEach(ev => {
                if(staffWorkload.hasOwnProperty(ev.prof)) staffWorkload[ev.prof]++;
            });

            if (workloadChart) workloadChart.destroy();
            workloadChart = new Chart(document.getElementById('workload-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(staffWorkload),
                    datasets: [{ label: 'Classes this Week', data: Object.values(staffWorkload), backgroundColor: '#4f46e5' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        async function renderStudentDashboard() {
            // ... Logic to render student stats
        }

        // --- ATTENDANCE & BIOMETRICS ---
        function openAttendancePortal() {
            const now = new Date();
            const cutoff = new Date();
            cutoff.setHours(8, 30, 0, 0); // 8:30 AM
            
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
            const scanBtn = document.getElementById('scan-biometric-btn');

            if (now > cutoff) {
                scanBtn.disabled = true;
                scanBtn.textContent = "Attendance Closed for Today";
                handleAbsence(currentUser.fullName, true); // Force absent
            } else {
                scanBtn.disabled = false;
                scanBtn.textContent = "Scan Fingerprint";
            }
            renderAttendanceDashboard();
            showModal('attendance-portal-modal');
        }
        
        function renderAttendanceDashboard() {
            const dashboard = document.getElementById('staff-status-dashboard');
            dashboard.innerHTML = '';
            const statusColors = { 'Present': 'bg-green-500', 'Absent': 'bg-red-500', 'Pending': 'bg-slate-400' };
            staffList.forEach(staff => {
                const status = attendanceStatus[staff.fullName] || 'Pending';
                dashboard.innerHTML += `<div class="flex items-center justify-between p-2 bg-slate-100 dark:bg-gray-700 rounded-md"><span class="font-semibold">${staff.fullName}</span><span class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full ${statusColors[status]}"></div>${status}</span></div>`;
            });
        }
        
        async function handleBiometricScan() {
            // ... Biometric simulation logic from previous responses ...
             const statusEl = document.getElementById('scanner-status');
            const scanner = document.getElementById('scanner-animation');
            scanner.classList.add('scanning');
            statusEl.textContent = 'Verifying...';
            setTimeout(async () => {
                scanner.classList.remove('scanning');
                const isSuccess = Math.random() > 0.1;
                const status = isSuccess ? 'Present' : 'Absent';
                statusEl.textContent = `Verification ${isSuccess ? 'Successful' : 'Failed'}. Marked as ${status}.`;
                
                const today = new Date().toISOString().slice(0, 10);
                const attendanceRef = doc(db, "attendance", today);
                await setDoc(attendanceRef, { [currentUser.fullName]: status }, { merge: true });

                if (!isSuccess) handleAbsence(currentUser.fullName);
            }, 2000);
        }

        async function handleAbsence(staffName, auto = false) {
            if (auto && attendanceStatus[staffName] === 'Present') return; // Don't override if already present
            
            const today = new Date().toISOString().slice(0, 10);
            const attendanceRef = doc(db, "attendance", today);
            await setDoc(attendanceRef, { [staffName]: 'Absent' }, { merge: true });
            
            showToast(`${staffName} marked absent. Colleagues will be notified.`, "info");
        }

        // --- CALENDAR & SCHEDULE ---
        function initializeCalendar() { /* As before */ }
        async function loadSchedule(scheduleId) { /* Logic to load schedule from Firestore */ }
        function renderCalendar() { /* Renders events from scheduleData */ }
        function handleEventClick(info) { /* Shows class details and actions */ }
        function handleEventDrop(info) { /* Handles drag-drop with conflict check */ }

        // --- AI CHATBOT "ACADEXI" ---
        async function handleChatSubmit(e) { e.preventDefault(); /* Full conversational logic */ }

        // --- UTILITIES ---
        function showModal(id) { document.getElementById(id)?.classList.add('visible'); }
        function hideModal(id) { document.getElementById(id)?.classList.remove('visible'); }
        function showToast(message, type) { /* Shows toast message */ }
        
        // --- DATABASE SEEDING ---
        async function checkAndSeedDatabase() {
            const seedRef = doc(db, "system", "seeded");
            const seedDoc = await getDoc(seedRef);
            if (!seedDoc.exists()) {
                console.log("Database is empty. Seeding initial data...");
                await seedUsers();
                await seedSchedules();
                await setDoc(seedRef, { status: true });
                showToast("Database has been initialized!", "success");
            }
        }

        async function seedUsers() {
            const batch = writeBatch(db);
            const users = [
                { uid: 'kashy@acadexa.com', fullName: 'Kashy', role: 'staff' },
                { uid: 'zap@acadexa.com', fullName: 'ZapAlert', role: 'staff' },
                { uid: 'anna@acadexa.com', fullName: 'Anna', role: 'staff' },
                { uid: 'mike@acadexa.com', fullName: 'Mike', role: 'staff' },
                { uid: 'sara@acadexa.com', fullName: 'Sara', role: 'staff' },
                { uid: 'leo@acadexa.com', fullName: 'Leo', role: 'staff' },
                { uid: 'nina@acadexa.com', fullName: 'Nina', role: 'staff' },
                { uid: 'raj@acadexa.com', fullName: 'Raj', role: 'staff' },
                { uid: 'yokesh@acadexa.com', fullName: 'Yokesh', role: 'student', scheduleId: 'grade-10-a' }
            ];
            // NOTE: The Auth UID will be different. This requires a more complex seeding script.
            // For this demo, we'll assume the user documents are created with the correct UID after manual user creation.
        }
        
        async function seedSchedules() { /* Logic to create initial schedules in Firestore */ }
    </script>
</body>
</html>

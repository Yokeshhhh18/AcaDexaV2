<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcaDexa - Advanced Scheduling Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            background-image: radial-gradient(circle at 15% 15%, rgba(79, 70, 229, 0.05) 0%, transparent 30%), radial-gradient(circle at 85% 75%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
        }
        .dark body {
            background-color: #111827;
            color: #e5e7eb;
            background-image: radial-gradient(circle at 15% 15%, rgba(79, 70, 229, 0.1) 0%, transparent 30%), radial-gradient(circle at 85% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 40%);
        }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        .modal {
            transition: opacity 0.3s, visibility 0.3s;
            visibility: hidden;
            opacity: 0;
        }
        .modal.visible {
            visibility: visible;
            opacity: 1;
        }
        .btn-icon {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        
        .modal-content { transition: transform 0.3s ease-out; transform: translateY(20px) scale(0.98); }
        .modal.visible .modal-content { transform: translateY(0) scale(1); }
        .toast { transition: opacity 0.3s, transform 0.3s; }
        :root { --fc-border-color: #e2e8f0; --fc-neutral-bg-color: rgba(241, 245, 249, 0.5); --fc-event-text-color: #fff; --fc-page-bg-color: transparent;}
        html.dark { --fc-border-color: #374151; --fc-neutral-bg-color: rgba(31, 41, 55, 0.5); --fc-page-bg-color: transparent;}
        .fc .fc-toolbar-title { @apply text-2xl font-bold font-poppins; }
        .fc .fc-button { @apply bg-indigo-600 border-indigo-600 hover:bg-indigo-700 text-white transition-colors duration-200; }
        .fc .fc-button-primary:disabled { @apply bg-indigo-400 dark:bg-indigo-800; }
        .fc .fc-daygrid-day.fc-day-today { @apply bg-indigo-50 dark:bg-indigo-900/20; }
        .fc-event { @apply text-xs border-0 cursor-pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .fc-event:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .fc-event.uncovered { @apply !bg-red-500 ring-2 ring-red-300; }

        .fc .fc-timegrid-event .fc-event-main {
            padding: 2px 4px;
            overflow: hidden;
            font-size: 0.75rem;
            font-weight: 600;
            color: white !important;
            white-space: normal;
            line-height: 1.2;
        }
        .repayment-offer-btn {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .repayment-offer-btn:hover {
             background-color: #dcfce7;
        }
        html.dark .repayment-offer-btn:hover {
            background-color: #14532d;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-gray-900 dark:text-slate-200">
    <header class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-3xl font-bold font-poppins tracking-tight">Aca<span class="text-indigo-500">Dexa</span></a>
            <div class="flex items-center gap-2 sm:gap-4">
                <div id="auth-container" class="flex items-center gap-2 sm:gap-4">
                    <button id="student-login-btn" class="text-sm font-semibold hover:text-indigo-600 dark:hover:text-indigo-400 transition">Student Login</button>
                    <button id="staff-login-btn" class="text-sm font-semibold bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Staff Login</button>
                </div>
                <div id="user-info-container" style="display: none;" class="flex items-center gap-4">
                        <button id="notifications-btn" class="relative p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                            <i data-lucide="bell"></i>
                            <span id="notification-badge" class="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center hidden"></span>
                        </button>
                        <button id="debt-ledger-btn" style="display: none;" class="flex items-center gap-2 text-sm font-semibold bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                            <i data-lucide="book-user" class="w-4 h-4"></i>
                            Debt Ledger
                        </button>
                        <button id="attendance-btn" style="display: none;" class="flex items-center gap-2 text-sm font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition">
                            <i data-lucide="fingerprint" class="w-4 h-4"></i>
                            Attendance
                        </button>
                        <span class="font-semibold" id="username-display"></span>
                        <button id="logout-btn" class="text-sm font-semibold hover:text-indigo-600 dark:hover:text-indigo-400 transition">Logout</button>
                </div>
                <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                    <i data-lucide="moon"></i>
                </button>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto p-4 sm:p-6">
        <div id="welcome-screen" class="hidden">
            <div class="text-center py-16">
                <h1 class="text-5xl md:text-7xl font-extrabold font-poppins tracking-tight">Welcome to Aca<span class="text-indigo-500">Dexa</span></h1>
                <p class="mt-4 text-lg text-slate-600 dark:text-slate-300">Your all-in-one solution for intelligent academic scheduling.</p>
                <p class="mt-2 text-slate-500">Please log in to access your dashboard and schedule.</p>
            </div>
        </div>

        <div id="app-wrapper" class="hidden">
            <div id="staff-dashboard" class="hidden"></div>
            <div id="student-dashboard" class="hidden"></div>
            <div id="admin-dashboard" class="hidden"></div>
            <div id="schedule-view" class="hidden mt-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div id="staff-schedule-tools" class="lg:col-span-1 hidden bg-white dark:bg-gray-800/50 p-4 rounded-xl shadow-md">
                        <h3 class="font-bold text-lg mb-4">Scheduling Tools</h3>
                        <p class="text-sm text-slate-500">Use the Admin dashboard to generate a master schedule for the week.</p>
                    </div>
                    <div id="main-schedule-area" class="lg:col-span-3">
                        <div class="bg-white dark:bg-gray-800/50 p-4 sm:p-6 rounded-xl shadow-md">
                            <div id="schedule-controls" class="flex flex-wrap gap-4 justify-between items-center mb-6">
                                <select id="schedule-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                                <div id="staff-schedule-filters" class="flex items-center gap-2 hidden">
                                    <label for="staff-view-selector" class="text-sm font-medium">View as:</label>
                                    <select id="staff-view-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="print-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2" title="Print Schedule"><i data-lucide="printer"></i> <span class="hidden sm:inline">Print</span></button>
                                    <button id="download-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2" title="Download as ICS"><i data-lucide="download"></i> <span class="hidden sm:inline">Download</span></button>
                                </div>
                            </div>
                            <div id="calendar-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button id="ask-ai-btn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg text-2xl z-40 hidden animate-bounce hover:animate-none">
        <i data-lucide="bot" class="w-8 h-8"></i>
    </button>
    <div id="toast" class="toast fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform -translate-y-10 z-[90]">
        <p id="toast-message"></p>
    </div>

    <div id="modals-container"></div>

    <script type="text/template" id="modals-template">
        <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-sm w-full relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 id="login-title" class="text-2xl font-bold mb-6 text-center font-poppins">Login</h3>
                <form id="auth-form">
                    <div class="space-y-4">
                        <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required>
                        <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
                    <button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Login</button>
                </form>
            </div>
        </div>

        <div id="attendance-portal-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 class="text-2xl font-bold mb-4 text-center">Biometric Attendance Portal</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="text-center">
                        <h4 class="font-bold mb-4">Scan to Verify Presence</h4>
                        <div id="scanner-animation" class="w-40 h-40 mx-auto flex items-center justify-center border-4 border-slate-300 dark:border-gray-600 rounded-full p-2">
                            <div class="inner-circle w-32 h-32 bg-indigo-500 rounded-full flex items-center justify-center text-white"><i data-lucide="fingerprint" class="w-16 h-16"></i></div>
                        </div>
                        <p id="scanner-status" class="mt-4 h-6 font-semibold"></p>
                        <button id="scan-biometric-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed">Scan Fingerprint</button>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Live Staff Status (<span id="current-time"></span>)</h4>
                        <div id="staff-status-dashboard" class="space-y-2 h-56 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="class-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 id="class-modal-title" class="text-2xl font-bold"></h3>
                <p id="class-modal-time" class="text-slate-500 mb-4"></p>
                <div class="space-y-3 border-t dark:border-gray-700 pt-4">
                    <div class="flex items-center gap-3"><i data-lucide="user" class="btn-icon text-indigo-500"></i><span id="class-modal-prof"></span></div>
                    <div class="flex items-center gap-3"><i data-lucide="map-pin" class="btn-icon text-indigo-500"></i><span id="class-modal-room"></span></div>
                    <div class="flex items-center gap-3"><i data-lucide="star" class="btn-icon text-indigo-500"></i><span id="class-modal-credits"></span></div>
                    <div id="notes-container" class="border-t dark:border-gray-700 pt-3 mt-3">
                        <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="notebook-text"></i>Lecture Notes</h4>
                        <div id="class-modal-notes-content" class="text-sm"></div>
                    </div>
                    <div id="action-container" class="mt-4 flex flex-col gap-2"></div>
                </div>
            </div>
        </div>
        
        <div id="notifications-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 class="text-2xl font-bold mb-4 font-poppins">Notifications</h3>
                 <div>
                    <h4 class="font-bold flex items-center gap-2 mb-2"><i data-lucide="alert-circle" class="text-amber-500"></i>System Alerts</h4>
                    <div id="alert-list" class="text-sm max-h-48 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="debt-ledger-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[85] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-4xl w-full relative h-[80vh] flex flex-col">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 class="text-2xl font-bold mb-4 font-poppins">Debt & Repayment Ledger</h3>
                <div id="debt-ledger-content" class="flex-grow overflow-y-auto">
                    </div>
            </div>
        </div>

        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-end justify-center sm:justify-end p-4 sm:p-6">
            <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md h-[70vh] flex flex-col">
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="bot" class="text-indigo-500"></i> AcaDexi Assistant</h3>
                    <button class="close-modal-btn text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                </div>
                <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col"></div>
                <div class="p-4 border-t dark:border-gray-700">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ask me anything..." class="flex-grow p-2 rounded-md dark:bg-gray-700 border-slate-300 dark:border-gray-600" >
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 rounded-lg transition"><i data-lucide="send"></i></button>
                    </form>
                </div>
            </div>
        </div>

        <div id="student-attendance-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[90] flex items-center justify-center p-4">
             <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button>
                <h3 id="student-attendance-title" class="text-2xl font-bold mb-4 font-poppins">Mark Student Attendance</h3>
                <div id="student-list-container" class="space-y-2 max-h-80 overflow-y-auto"></div>
                <button id="save-student-attendance-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Save Attendance</button>
            </div>
        </div>
        
        <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[99] flex items-center justify-center p-4">
            <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h4 id="confirm-modal-title" class="text-lg font-bold mb-4">Confirm Action</h4>
                <p id="confirm-modal-message" class="mb-6 text-slate-600 dark:text-slate-300"></p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button id="confirm-modal-confirm" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Confirm</button>
                </div>
            </div>
        </div>
    </script>

    <script>
        // --- LOCAL DATABASE SIMULATION & INITIALIZATION ---
        let currentUser = null;
        let calendar = null;
        let activeLoginRole = null;
        let workloadChart = null;
        let db = {};
        let confirmCallback = null;

        const initialDB = {
            users: {
                'anamika@acadexa.com': { id: 'anamika@acadexa.com', fullName: 'Anamika', role: 'staff', password: 'password123' },
                'kanishq@acadexa.com': { id: 'kanishq@acadexa.com', fullName: 'Kanishq', role: 'staff', password: 'password123' },
                'saravana@acadexa.com': { id: 'saravana@acadexa.com', fullName: 'Saravana', role: 'staff', password: 'password123' },
                'harine@acadexa.com': { id: 'harine@acadexa.com', fullName: 'Harine', role: 'staff', password: 'password123' },
                'kiruthik@acadexa.com': { id: 'kiruthik@acadexa.com', fullName: 'Kiruthik', role: 'staff', password: 'password123' },
                'balaji@acadexa.com': { id: 'balaji@acadexa.com', fullName: 'Balaji', role: 'staff', password: 'password123' },
                'karthikeyan@acadexa.com': { id: 'karthikeyan@acadexa.com', fullName: 'Karthikeyan', role: 'staff', password: 'password123' },
                'yokesh@acadexa.com': { id: 'yokesh@acadexa.com', fullName: 'Yokesh', role: 'staff', password: 'password123' },
                'raghu@acadexa.com': { id: 'raghu@acadexa.com', fullName: 'Raghu', role: 'student', password: 'student123', scheduleId: 'grade-10-a' },
                'admin@acadexa.com': { id: 'admin@acadexa.com', fullName: 'Admin', role: 'admin', password: 'adminpassword'}
            },
            schedules: { 'grade-10-a': { name: 'Grade 10 - Section A', events: {}, overrides: {} } },
            staffAttendance: {},
            studentAttendance: { 'raghu@acadexa.com': {} },
            classDebts: [],
            repaymentOffers: [],
            alerts: [],
            holidays: {},
            attendanceCutoff: { hours: 10, minutes: 0 }
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modals-container').innerHTML = document.getElementById('modals-template').innerHTML;
            lucide.createIcons();
            loadDatabase();
            setupEventListeners();
            checkLoginState();
        });
        
        function getYYYYMMDD(d) {
            return d.toISOString().split('T')[0];
        }

        function loadDatabase() {
            const savedDB = localStorage.getItem('acadexaDB');
            if (savedDB) {
                db = JSON.parse(savedDB);
                if (!db.holidays) db.holidays = {};
                if (!db.alerts) db.alerts = [];
                if (!db.repaymentOffers) db.repaymentOffers = [];
                if (!db.users || Object.keys(db.users).length === 0) db.users = initialDB.users;
                
                if (!db.schedules || !db.schedules['grade-10-a'] || Object.keys(db.schedules['grade-10-a'].events).length === 0) {
                     db.schedules['grade-10-a'].events = generateNewSchedule('grade-10-a', false);
                }
                if(!db.schedules['grade-10-a'].overrides) db.schedules['grade-10-a'].overrides = {};

            } else {
                db = JSON.parse(JSON.stringify(initialDB));
                db.schedules['grade-10-a'].events = generateNewSchedule('grade-10-a', false);
                saveDatabase();
            }
        }

        function saveDatabase() {
            localStorage.setItem('acadexaDB', JSON.stringify(db));
        }

        function checkLoginState() {
            const loggedInUserId = sessionStorage.getItem('acadexaUser');
            if (loggedInUserId && db.users && db.users[loggedInUserId]) {
                currentUser = db.users[loggedInUserId];
                initializeAppUI(true);
            } else {
                initializeAppUI(false);
            }
        }

        function initializeAppUI(isLoggedIn) {
            updateHeaderUI(isLoggedIn);
            if (isLoggedIn) {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                ['staff-dashboard', 'student-dashboard', 'admin-dashboard', 'schedule-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('main-schedule-area').classList.remove('lg:col-span-4');
                document.getElementById('main-schedule-area').classList.add('lg:col-span-3');

                if (!calendar) initializeCalendar();

                if (currentUser.role === 'staff') {
                    document.getElementById('staff-dashboard').classList.remove('hidden');
                    document.getElementById('schedule-view').classList.remove('hidden');
                    document.getElementById('staff-schedule-tools').style.display = 'none'; // Hide old tools
                    document.getElementById('main-schedule-area').classList.remove('lg:col-span-3');
                    document.getElementById('main-schedule-area').classList.add('lg:col-span-4');
                    renderStaffDashboard();
                    populateScheduleSelector();
                    loadSchedule('grade-10-a');
                } else if (currentUser.role === 'student') {
                    document.getElementById('student-dashboard').classList.remove('hidden');
                    document.getElementById('schedule-view').classList.remove('hidden');
                    document.getElementById('staff-schedule-tools').style.display = 'none';
                    document.getElementById('main-schedule-area').classList.remove('lg:col-span-3');
                    document.getElementById('main-schedule-area').classList.add('lg:col-span-4');
                    renderStudentDashboard();
                    populateScheduleSelector();
                    loadSchedule(currentUser.scheduleId);
                } else if (currentUser.role === 'admin') {
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    renderAdminDashboard();
                }
                
                updateNotifications();
            } else {
                document.getElementById('welcome-screen').classList.remove('hidden');
                document.getElementById('app-wrapper').classList.add('hidden');
                hideAllModals(); 
            }
        }
        
        function updateHeaderUI(isLoggedIn) {
            document.getElementById('auth-container').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('user-info-container').style.display = isLoggedIn ? 'flex' : 'none';
            if(isLoggedIn) {
                document.getElementById('username-display').textContent = `${currentUser.fullName}`;
            }
            document.getElementById('ask-ai-btn').style.display = isLoggedIn ? 'flex' : 'none';
            document.getElementById('notifications-btn').style.display = isLoggedIn && (currentUser.role === 'staff' || currentUser.role === 'admin') ? 'flex' : 'none';
            document.getElementById('staff-schedule-filters').style.display = isLoggedIn && currentUser.role === 'staff' ? 'flex' : 'none';
            document.getElementById('attendance-btn').style.display = isLoggedIn && currentUser.role === 'staff' ? 'flex' : 'none';
            document.getElementById('debt-ledger-btn').style.display = isLoggedIn && currentUser.role === 'staff' ? 'flex' : 'none';
        }

        function setupEventListeners() {
            document.getElementById('student-login-btn').onclick = () => openLoginModal('student');
            document.getElementById('staff-login-btn').onclick = () => openLoginModal('staff');
            document.getElementById('attendance-btn').onclick = openAttendancePortal;
            document.getElementById('debt-ledger-btn').onclick = openDebtLedger;
            document.getElementById('logout-btn').onclick = handleLogout;
            document.getElementById('auth-form').onsubmit = handleAuthSubmit;
            document.getElementById('scan-biometric-btn').onclick = handleBiometricScan;
            document.getElementById('ask-ai-btn').onclick = () => showModal('ai-chat-modal');
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
            document.getElementById('notifications-btn').onclick = openNotifications;
            
            document.getElementById('dark-mode-toggle').onclick = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                document.querySelector('#dark-mode-toggle i').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
                if(workloadChart) renderStaffDashboard(); 
            };

            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                document.querySelector('#dark-mode-toggle i').setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();

            document.getElementById('schedule-selector').onchange = (e) => loadSchedule(e.target.value);
            document.getElementById('staff-view-selector').onchange = () => renderCalendar();
            document.getElementById('print-btn').onclick = () => window.print();
            document.getElementById('download-btn').onclick = downloadScheduleICS;
            
            document.addEventListener('click', (e) => {
                if (e.target.closest('.close-modal-btn')) {
                    hideModal(e.target.closest('.modal').id);
                }
                if (e.target.closest('.cover-class-btn')) {
                    const eventId = e.target.closest('.cover-class-btn').dataset.eventid;
                    showConfirmModal(`Are you sure you want to cover this class for ${e.target.closest('.cover-class-btn').dataset.originalprof}? A debt will be created.`, () => {
                         claimUncoveredClass(eventId);
                    });
                }
                if (e.target.closest('.repay-debt-btn')) {
                    const debtId = e.target.dataset.id;
                    renderRepaymentView(debtId);
                }
                if (e.target.closest('.repayment-offer-btn')) {
                    e.preventDefault();
                    const debtId = e.currentTarget.dataset.debtid;
                    const eventJson = e.currentTarget.dataset.event;
                    handleRepaymentOffer(debtId, JSON.parse(eventJson));
                }
                if (e.target.closest('.accept-offer-btn')) {
                    const offerId = e.target.dataset.offerid;
                    handleAcceptOffer(offerId);
                }
            });

            document.getElementById('confirm-modal-confirm').onclick = () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideModal('confirm-modal');
                confirmCallback = null;
            };
            document.getElementById('confirm-modal-cancel').onclick = () => {
                hideModal('confirm-modal');
                confirmCallback = null;
            };
        }
        
        function openLoginModal(role) {
            activeLoginRole = role;
            let title = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            if (role === 'staff') {
                 title = 'Staff / Admin Login';
            }
            document.getElementById('login-title').textContent = title;
            showModal('login-modal');
        }

        function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value.toLowerCase();
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            
            const user = db.users ? db.users[email] : null;
            
            const validRole = user && (user.role === activeLoginRole || (activeLoginRole === 'staff' && user.role === 'admin'));

            if (user && user.password === password && validRole) {
                currentUser = user;
                sessionStorage.setItem('acadexaUser', currentUser.id);
                hideModal('login-modal');
                initializeAppUI(true);
            } else {
                errorEl.textContent = "Invalid credentials for this role.";
            }
        }
        
        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('acadexaUser');
            if(calendar) calendar.destroy();
            calendar = null;
            initializeAppUI(false);
        }

        function renderAdminDashboard() {
            const dash = document.getElementById('admin-dashboard');
            dash.innerHTML = `<h2 class="text-3xl font-bold mb-6 font-poppins">Admin Controls</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold text-lg mb-4">Master Schedule Generation</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">This will generate a new, fully packed and balanced weekly timetable.</p>
                        <button id="generate-schedule-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                            <i data-lucide="shuffle"></i> Generate New Schedule
                        </button>
                    </div>
                </div>`;
            lucide.createIcons();
            
            document.getElementById('generate-schedule-btn').onclick = () => {
                showConfirmModal('Are you sure you want to generate a new schedule? This will overwrite the current one and clear all debts.', () => generateNewSchedule('grade-10-a', true));
            };
        }

        function renderStaffDashboard() {
            const dash = document.getElementById('staff-dashboard');
            dash.innerHTML = `<h2 class="text-3xl font-bold mb-6 font-poppins">Staff Dashboard</h2>
                <div class="bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4">Weekly Class Load (in Hours)</h3>
                    <canvas id="workload-chart"></canvas>
                </div>`;
            
            const staffWorkload = {};
            const staffList = Object.values(db.users).filter(u => u.role === 'staff');
            staffList.forEach(s => { staffWorkload[s.fullName] = 0; });

            const schedule = db.schedules['grade-10-a'];
            if(schedule && schedule.events) {
                Object.values(schedule.events).forEach(ev => {
                    if(staffWorkload.hasOwnProperty(ev.prof)) {
                        const duration = (new Date(`1970-01-01T${ev.endTime}:00`) - new Date(`1970-01-01T${ev.startTime}:00`)) / (1000 * 60);
                        staffWorkload[ev.prof] += duration / 50;
                    }
                });
            }

            if (workloadChart) workloadChart.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            workloadChart = new Chart(document.getElementById('workload-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(staffWorkload),
                    datasets: [ { label: 'Class Periods this Week', data: Object.values(staffWorkload), backgroundColor: '#4f46e5' } ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: isDark ? '#cbd5e1' : '#475569', stepSize: 1 }, grid: { color: isDark ? '#374151' : '#e2e8f0' } },
                        x: { ticks: { color: isDark ? '#cbd5e1' : '#475569' }, grid: { color: 'transparent' } }
                    },
                    plugins: { legend: { labels: { color: isDark ? '#cbd5e1' : '#475569' } } }
                }
            });
        }
        
        function handleAbsence(staffName, auto = false) {
            const todayStr = getYYYYMMDD(new Date());
            if (!db.staffAttendance[todayStr]) db.staffAttendance[todayStr] = {};
            if (db.staffAttendance[todayStr][staffName] === 'Absent') return;

            db.staffAttendance[todayStr][staffName] = 'Absent';
            
            db.alerts.push({ 
                id: `alert_${Date.now()}`, 
                message: `${staffName} has been marked absent. Their classes are available to cover.`, 
                date: new Date().toISOString() 
            });

            showToast(`${staffName} is absent.`, "info");
            updateNotifications();
            saveDatabase();
            renderCalendar();
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar-container');
            if (calendar) calendar.destroy();
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                initialDate: '2025-10-01',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
                slotMinTime: '09:00:00',
                slotMaxTime: '16:00:00',
                slotDuration: '00:50:00',
                slotLabelInterval: '00:50:00',
                allDaySlot: false,
                editable: false, 
                eventClick: handleEventClick,
                businessHours: [ { daysOfWeek: [ 1, 2, 3, 4, 5 ], startTime: '09:00', endTime: '16:00' } ],
                events: (fetchInfo, successCallback, failureCallback) => {
                    const schedule = db.schedules['grade-10-a'];
                    if (!schedule) { failureCallback('Schedule not found'); return; }
                    
                    let finalEvents = Object.values(schedule.events).map(e => ({...e})); 
                    Object.values(schedule.overrides).forEach(override => finalEvents.push(override));

                    const breakEvents = [
                        { title: 'Short Break', startTime: '10:40', endTime: '10:55', display: 'block', backgroundColor: '#a1a1aa', classNames: ['break-event'], daysOfWeek: [1,2,3,4,5] },
                        { title: 'Lunch Break', startTime: '12:35', endTime: '13:30', display: 'block', backgroundColor: '#a1a1aa', classNames: ['break-event'], daysOfWeek: [1,2,3,4,5] }
                    ];
                    finalEvents.push(...breakEvents);

                    const staffView = document.getElementById('staff-view-selector').value;
                    let filteredEvents = finalEvents;
                    if (currentUser && currentUser.role === 'staff' && staffView !== 'full-class') {
                        filteredEvents = finalEvents.filter(e => {
                            if (e.classNames?.includes('break-event')) return true;
                            return e.prof === staffView || e.originalProf === staffView;
                        });
                    }
                    successCallback(filteredEvents);
                },
                 eventContent: (arg) => {
                    if (arg.event.classNames.includes('break-event')) {
                        return { html: `<div style="text-align:center; font-weight: bold; color: #4b5563;">${arg.event.title}</div>`};
                    }
                    const todayStr = getYYYYMMDD(arg.event.start);
                    const staffAttendance = db.staffAttendance[todayStr] || {};
                    const originalProf = arg.event.extendedProps.originalProf || arg.event.extendedProps.prof;
                    let title = arg.event.title;
                    if (staffAttendance[originalProf] === 'Absent' && !arg.event.extendedProps.originalProf) {
                        title = `${title} (UNCOVERED)`;
                    } else if (arg.event.extendedProps.originalProf) {
                        title = `${title} (Cover: ${arg.event.extendedProps.prof.split(' ')[0]})`;
                    }
                    let eventEl = document.createElement('div');
                    eventEl.innerHTML = title;
                    return { domNodes: [eventEl] }
                 }
            });
            calendar.render();
        }

        function loadSchedule(scheduleId) {
            if (!db.schedules[scheduleId]) {
                showToast("Schedule not found!", "error");
                return;
            }
            document.getElementById('schedule-selector').value = scheduleId;
            document.getElementById('schedule-view').classList.remove('hidden');
            if(calendar) {
                calendar.gotoDate('2025-10-01');
                calendar.refetchEvents();
            }
        }
        
        function renderCalendar() {
            if (calendar) {
                calendar.refetchEvents();
            }
        }

        function populateScheduleSelector() {
            const selector = document.getElementById('schedule-selector');
            selector.innerHTML = Object.entries(db.schedules)
                .map(([id, data]) => `<option value="${id}">${data.name}</option>`).join('');
            
            if(currentUser?.role === 'staff') {
                const staffSelector = document.getElementById('staff-view-selector');
                const staffOptions = Object.values(db.users)
                    .filter(u => u.role === 'staff')
                    .map(s => `<option value="${s.fullName}">${s.fullName}</option>`).join('');
                staffSelector.innerHTML = `<option value="full-class">Full Class View</option>${staffOptions}`;
                staffSelector.value = 'full-class';
            }
        }
        
        function handleEventClick(info) {
             if (info.event.classNames.includes('break-event')) return;
            const scheduleId = document.getElementById('schedule-selector').value;
            const eventData = db.schedules[scheduleId].overrides[info.event.id] || db.schedules[scheduleId].events[info.event.id] || info.event.extendedProps;
            
            const modal = document.getElementById('class-details-modal');
            modal.querySelector('#class-modal-title').textContent = info.event.title;
            modal.querySelector('#class-modal-time').textContent = `${info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            
            const currentProf = info.event.extendedProps.prof;
            const originalProf = info.event.extendedProps.originalProf || currentProf;

            modal.querySelector('#class-modal-prof').textContent = `Prof. ${currentProf}`;
            if(info.event.extendedProps.originalProf) {
                modal.querySelector('#class-modal-prof').textContent += ` (Covering for ${info.event.extendedProps.originalProf})`;
            }

            modal.querySelector('#class-modal-room').textContent = `Room: ${eventData.room}`;
            modal.querySelector('#class-modal-credits').textContent = `${eventData.credits} Credits`;
            
            const notesContent = modal.querySelector('#class-modal-notes-content');
            const actionContainer = document.getElementById('action-container');
            actionContainer.innerHTML = '';

            const isMyClass = currentProf === currentUser.fullName;
            const isUncovered = info.event.title.includes('UNCOVERED');

            notesContent.innerHTML = `<textarea id="notes-textarea" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" rows="3" ${!isMyClass ? 'readonly' : ''}>${eventData.notes || ''}</textarea>`;

            if (currentUser.role === 'staff') {
                if(isMyClass){
                    // Add Save Notes and Mark Attendance buttons
                } else if(isUncovered) {
                    const coverClassBtn = document.createElement('button');
                    coverClassBtn.innerHTML = `<i data-lucide="user-plus"></i> Cover This Class (FCFS)`;
                    coverClassBtn.className = 'w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition cover-class-btn';
                    coverClassBtn.dataset.eventid = info.event.id;
                    coverClassBtn.dataset.originalprof = originalProf;
                    actionContainer.appendChild(coverClassBtn);
                }
            }
            lucide.createIcons();
            showModal('class-details-modal');
        }
        
        function claimUncoveredClass(eventId) {
            const scheduleId = document.getElementById('schedule-selector').value;
            const schedule = db.schedules[scheduleId];
            const eventInstance = calendar.getEventById(eventId);

            if (!eventInstance) { showToast("Error: Class not found.", "error"); return; }
            
            const originalProf = eventInstance.extendedProps.prof;
            if (originalProf === currentUser.fullName) { showToast("You cannot cover your own class.", "error"); return; }

            const eventDate = getYYYYMMDD(eventInstance.start);
            const overrideId = `override_${eventDate}_${eventInstance.id}`;

            if(schedule.overrides[overrideId]){ showToast("This class is already covered.", "error"); hideModal('class-details-modal'); return; }

            schedule.overrides[overrideId] = {
                id: overrideId,
                title: eventInstance.title.replace(' (UNCOVERED)', ''),
                start: eventInstance.start.toISOString(),
                end: eventInstance.end.toISOString(),
                prof: currentUser.fullName,
                originalProf: originalProf,
                room: eventInstance.extendedProps.room,
                credits: eventInstance.extendedProps.credits,
                backgroundColor: '#059669',
            };

            db.classDebts.push({
                id: `debt_${Date.now()}`,
                debtor: originalProf,
                creditor: currentUser.fullName,
                classInfo: { title: schedule.overrides[overrideId].title, start: eventInstance.start.toISOString() },
                status: 'Unpaid'
            });
            
            saveDatabase();
            hideModal('class-details-modal');
            renderCalendar();
            updateNotifications();
            showToast(`You are now covering this class for ${originalProf}.`, 'success');
        }

        function updateNotifications() {
            if (!currentUser || currentUser.role !== 'staff') return;
            const myDebts = db.classDebts.filter(d => (d.debtor === currentUser.fullName || d.creditor === currentUser.fullName) && d.status === 'Unpaid');
            const myOffers = db.repaymentOffers.filter(o => o.creditor === currentUser.fullName && o.status === 'Pending');
            const totalNotifications = myDebts.length + db.alerts.length + myOffers.length;
            const badge = document.getElementById('notification-badge');
            
            if (totalNotifications > 0) {
                badge.textContent = totalNotifications;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openNotifications() {
            const alertList = document.getElementById('alert-list');
            alertList.innerHTML = db.alerts.length === 0 ? '<p class="text-slate-500">No new system alerts.</p>' : db.alerts.slice().reverse().map(alert => `<div class="p-3 bg-slate-100 dark:bg-gray-700 rounded-md"><p>${alert.message}</p><p class="text-xs text-slate-500 mt-1">${new Date(alert.date).toLocaleString()}</p></div>`).join('');
            
            db.alerts = [];
            updateNotifications();
            saveDatabase();
            showModal('notifications-modal');
        }

        function openDebtLedger() {
            renderDebtLedgerMainView();
            showModal('debt-ledger-modal');
        }

        function renderDebtLedgerMainView() {
            const content = document.getElementById('debt-ledger-content');
            const myDebts = db.classDebts.filter(d => d.debtor === currentUser.fullName && d.status === 'Unpaid');
            const debtsToMe = db.classDebts.filter(d => d.creditor === currentUser.fullName && d.status === 'Unpaid');
            const offersToMe = db.repaymentOffers.filter(o => o.creditor === currentUser.fullName && o.status === 'Pending');

            let iOweHtml = myDebts.length > 0 ? myDebts.map(d => `
                <div class="flex justify-between items-center p-3 bg-slate-100 dark:bg-gray-700 rounded-md">
                    <div>
                        <p>You owe <strong>${d.creditor}</strong> for covering <strong>${d.classInfo.title}</strong></p>
                        <p class="text-xs text-slate-500">${new Date(d.classInfo.start).toLocaleString()}</p>
                    </div>
                    <button data-id="${d.id}" class="repay-debt-btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Repay Debt</button>
                </div>`).join('') : '<p class="text-slate-500">You have no pending debts.</p>';

            let owedToMeHtml = debtsToMe.length > 0 ? debtsToMe.map(d => `
                <div class="p-3 bg-slate-100 dark:bg-gray-700 rounded-md">
                    <p><strong>${d.debtor}</strong> owes you for <strong>${d.classInfo.title}</strong></p>
                </div>`).join('') : '<p class="text-slate-500">No one owes you any classes.</p>';

            let offersHtml = offersToMe.length > 0 ? offersToMe.map(o => {
                const debt = db.classDebts.find(d => d.id === o.debtId);
                return `
                <div class="flex justify-between items-center p-3 bg-amber-100 dark:bg-amber-900/50 rounded-md border border-amber-400">
                    <div>
                        <p><strong>${o.debtor}</strong> offers to cover your <strong>${o.classToCover.title}</strong> class</p>
                        <p class="text-xs text-slate-500">On ${new Date(o.classToCover.start).toLocaleString()} to settle their debt for ${debt.classInfo.title}.</p>
                    </div>
                    <button data-offerid="${o.id}" class="accept-offer-btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Accept Offer</button>
                </div>`
            }).join('') : '';

            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-xl font-bold mb-3 border-b pb-2">Debts I Owe</h4>
                        <div class="space-y-3">${iOweHtml}</div>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold mb-3 border-b pb-2">Debts Owed to Me & Offers</h4>
                        <div class="space-y-3">${offersHtml}${owedToMeHtml}</div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderRepaymentView(debtId) {
            const content = document.getElementById('debt-ledger-content');
            const debt = db.classDebts.find(d => d.id === debtId);
            const creditorName = debt.creditor;
            
            const upcomingEvents = calendar.getEvents().filter(e => 
                new Date(e.start) > new Date() &&
                e.extendedProps.prof === creditorName &&
                !e.classNames.includes('break-event')
            ).sort((a,b) => a.start - b.start).slice(0, 10);

            let eventsHtml = upcomingEvents.length > 0 ? upcomingEvents.map(e => {
                const eventData = { id: e.id, title: e.title, start: e.start.toISOString(), end: e.end.toISOString(), room: e.extendedProps.room, credits: e.extendedProps.credits, prof: e.extendedProps.prof };
                return `
                <div data-debtid="${debtId}" data-event='${JSON.stringify(eventData)}' class="repayment-offer-btn p-3 bg-slate-100 dark:bg-gray-700 rounded-md">
                    <p><strong>${e.title}</strong></p>
                    <p class="text-sm">${new Date(e.start).toLocaleString()}</p>
                </div>`
            }).join('') : '<p class="text-slate-500">No upcoming classes for this staff member to cover.</p>';

            content.innerHTML = `
                <button onclick="renderDebtLedgerMainView()" class="mb-4 text-indigo-600 font-semibold flex items-center gap-2"><i data-lucide="arrow-left"></i> Back to Ledger</button>
                <h4 class="text-xl font-bold mb-3">Offer to cover a class for ${creditorName}</h4>
                <p class="mb-4 text-sm text-slate-500">Select one of their upcoming classes below to offer a repayment.</p>
                <div class="space-y-3">${eventsHtml}</div>
            `;
            lucide.createIcons();
        }

        function handleRepaymentOffer(debtId, eventToCover) {
            const debt = db.classDebts.find(d => d.id === debtId);
            const offer = {
                id: `offer_${Date.now()}`,
                debtId: debtId,
                debtor: currentUser.fullName,
                creditor: debt.creditor,
                classToCover: eventToCover,
                status: 'Pending'
            };
            db.repaymentOffers.push(offer);
            saveDatabase();
            showToast('Repayment offer sent!', 'success');
            renderDebtLedgerMainView();
            updateNotifications();
        }

        function handleAcceptOffer(offerId) {
            const offer = db.repaymentOffers.find(o => o.id === offerId);
            if (!offer) return;
            const debt = db.classDebts.find(d => d.id === offer.debtId);
            const schedule = db.schedules['grade-10-a'];

            debt.status = 'Paid';
            offer.status = 'Accepted';

            const overrideId = `override_repayment_${Date.now()}`;
            schedule.overrides[overrideId] = {
                id: overrideId,
                title: offer.classToCover.title,
                start: offer.classToCover.start,
                end: offer.classToCover.end,
                prof: offer.debtor,
                originalProf: offer.creditor,
                room: offer.classToCover.room,
                credits: offer.classToCover.credits,
                backgroundColor: '#f59e0b',
            };

            saveDatabase();
            showToast('Repayment offer accepted and schedule updated!', 'success');
            renderDebtLedgerMainView();
            renderCalendar();
            updateNotifications();
        }
        
        function generateNewSchedule(scheduleId, fromAdmin) {
            if(fromAdmin) showToast('Generating new schedule with all rules...', 'info');

            const subjectDefinitions = [
                { baseTitle: 'IoT', type: 'lab', prof: 'Karthikeyan', room: 'CS Lab', credits: 4, weeklyCount: 1, color: '#8b5cf6' },
                { baseTitle: 'IoT', type: 'theory', prof: 'Karthikeyan', room: '101', credits: 4, weeklyCount: 2, color: '#6d28d9' },
                { baseTitle: 'Power Systems', type: 'theory', prof: 'Anamika', room: '102', credits: 3, weeklyCount: 3, color: '#1d4ed8' },
                { baseTitle: 'Elec. Hybrid Vehicle', type: 'theory', prof: 'Balaji', room: '103', credits: 3, weeklyCount: 2, color: '#c026d3' },
                { baseTitle: 'EV Architecture', type: 'lab', prof: 'Yokesh', room: 'Lab A', credits: 4, weeklyCount: 1, color: '#059669' },
                { baseTitle: 'EV Architecture', type: 'theory', prof: 'Yokesh', room: '201', credits: 4, weeklyCount: 2, color: '#047857' },
                { baseTitle: 'Ethics', type: 'theory', prof: 'Kiruthik', room: '202', credits: 2, weeklyCount: 2, color: '#ca8a04' },
                { baseTitle: 'LIC', type: 'lab', prof: 'Saravana', room: 'Lab B', credits: 4, weeklyCount: 1, color: '#e11d48' },
                { baseTitle: 'LIC', type: 'theory', prof: 'Saravana', room: '203', credits: 4, weeklyCount: 2, color: '#be123c' },
                { baseTitle: 'Advanced E-Vehicles', type: 'theory', prof: 'Kanishq', room: '103', credits: 3, weeklyCount: 2, color: '#15803d' },
                { baseTitle: 'Comm. Skills', type: 'theory', prof: 'Harine', room: '202', credits: 2, weeklyCount: 2, color: '#f97316' }
            ];

            let classDeck = [];
            subjectDefinitions.forEach(def => {
                for (let i = 0; i < def.weeklyCount; i++) {
                    classDeck.push({ title: def.baseTitle + (def.type === 'lab' ? ' (Lab)' : ''), type: def.type, prof: def.prof, room: def.room, credits: def.credits, backgroundColor: def.color });
                }
            });

            const staffList = Object.values(db.users).filter(u => u.role === 'staff');
            let totalHoursToFill = 34;
            let currentHours = classDeck.reduce((acc, c) => acc + (c.type === 'lab' ? 2 : 1), 0);

            if (currentHours < totalHoursToFill) {
                let staffIndex = 0;
                for (let i = currentHours; i < totalHoursToFill; i++) {
                    const prof = staffList[staffIndex % staffList.length].fullName;
                    classDeck.push({ title: 'Study Hall', type: 'theory', prof: prof, room: 'Library', credits: 0, backgroundColor: '#64748b' });
                    staffIndex++;
                }
            }
            
            for (let i = classDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [classDeck[i], classDeck[j]] = [classDeck[j], classDeck[i]];
            }

            const labClasses = classDeck.filter(c => c.type === 'lab');
            const theoryClasses = classDeck.filter(c => c.type === 'theory');
            
            const timeSlots = ['09:00', '09:50', '10:55', '11:45', '13:30', '14:20', '15:10'];
            let availableSlots = [];
            for (let day = 1; day <= 5; day++) {
                timeSlots.forEach(time => {
                    if (day === 3 && time === '15:10') return; 
                    availableSlots.push({ day, time });
                });
            }
            
            const newEvents = {};
            const profWorkload = {};
            staffList.forEach(s => profWorkload[s.fullName] = 0);

            const isConflict = (classInfo, day, startTime, duration) => {
                for (let i = 0; i < duration; i += 50) {
                    const checkTime = new Date(new Date(`1970-01-01T${startTime}:00`).getTime() + i * 60000).toTimeString().slice(0, 5);
                    for (const event of Object.values(newEvents)) {
                        if (event.daysOfWeek.includes(day)) {
                            const eventStart = event.startTime;
                            const eventEnd = event.endTime;
                            if (checkTime >= eventStart && checkTime < eventEnd) {
                                if (event.prof === classInfo.prof || event.room === classInfo.room) return true;
                            }
                        }
                    }
                }
                return false;
            };

            labClasses.forEach(labInfo => {
                for (let i = 0; i < availableSlots.length - 1; i++) {
                    const slot1 = availableSlots[i];
                    const slot2 = availableSlots[i + 1];
                    const slot1End = new Date(new Date(`1970-01-01T${slot1.time}:00`).getTime() + 50 * 60000).toTimeString().slice(0, 5);
                    if (slot1.day === slot2.day && slot1End === slot2.time && !isConflict(labInfo, slot1.day, slot1.time, 100)) {
                        const eventId = `event_${Object.keys(newEvents).length}`;
                        newEvents[eventId] = { ...labInfo, id: eventId, daysOfWeek: [slot1.day], startTime: slot1.time, endTime: new Date(new Date(`1970-01-01T${slot2.time}:00`).getTime() + 50 * 60000).toTimeString().slice(0,5) };
                        profWorkload[labInfo.prof] += 2;
                        availableSlots.splice(i, 2);
                        break;
                    }
                }
            });

            theoryClasses.sort((a,b) => profWorkload[a.prof] - profWorkload[b.prof]);
            theoryClasses.forEach(theoryInfo => {
                for (let i = 0; i < availableSlots.length; i++) {
                    const slot = availableSlots[i];
                    if (!isConflict(theoryInfo, slot.day, slot.time, 50)) {
                        const eventId = `event_${Object.keys(newEvents).length}`;
                        newEvents[eventId] = { ...theoryInfo, id: eventId, daysOfWeek: [slot.day], startTime: slot.time, endTime: new Date(new Date(`1970-01-01T${slot.time}:00`).getTime() + 50 * 60000).toTimeString().slice(0,5) };
                        profWorkload[theoryInfo.prof]++;
                        availableSlots.splice(i, 1);
                        break;
                    }
                }
            });
            
            if(fromAdmin) {
                db.schedules[scheduleId].events = newEvents;
                db.schedules[scheduleId].overrides = {};
                db.alerts = []; db.classDebts = []; db.repaymentOffers = [];
                saveDatabase();
                showToast('New schedule generated!', 'success');
                renderStaffDashboard();
                loadSchedule(scheduleId);
            }
            return newEvents;
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcaDexa - Smart Scheduling Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; @apply bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-slate-200; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .hero-bg { background-color: #111827; background-image: radial-gradient(circle at top right, rgba(79, 70, 229, 0.4), transparent 40%); }
        .feature-card { transition: transform 0.3s ease, box-shadow 0.3s ease; @apply bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .unscheduled-item { cursor: grab; transition: all 0.2s ease-in-out; }
        .unscheduled-item:hover { transform: scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        :root { --fc-border-color: #e2e8f0; --fc-daygrid-event-dot-width: 8px; --fc-list-event-hover-bg-color: #f1f5f9; }
        html.dark { --fc-border-color: #374151; --fc-day-bg-color: #1f2937; --fc-list-event-hover-bg-color: #374151; --fc-today-bg-color: rgba(31, 41, 55, 0.8); }
        .fc .fc-toolbar-title { @apply text-xl font-bold text-slate-800 dark:text-slate-100; }
        .fc .fc-button { @apply bg-indigo-600 border-indigo-600 hover:bg-indigo-700 hover:border-indigo-700; }
        .fc .fc-button-primary:not(:disabled).fc-button-active { @apply bg-indigo-700 border-indigo-700; }
        .fc-event { border-width: 2px !important; cursor: pointer; }
        .fc-event.conflict { border: 2px solid #ef4444 !important; animation: pulse-red 1s infinite; }
        .fc-event.absent { @apply opacity-60 bg-slate-400 border-slate-500 line-through decoration-2 decoration-red-500; }
        .fc-event.filtered-out { @apply opacity-20 pointer-events-none; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .toggle-checkbox:checked { @apply bg-indigo-600 right-0 border-indigo-600; }
        .toggle-checkbox:checked + .toggle-label { @apply bg-indigo-600; }
        .notification-badge { @apply absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700/50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-white tracking-wider font-poppins">Aca<span class="text-indigo-400">Dexa</span></div>
            <div class="hidden md:flex space-x-8 items-center">
                <a href="#features" class="text-gray-300 hover:text-indigo-400 transition">Core Features</a>
                <a href="#schedule-workspace" class="text-gray-300 hover:text-indigo-400 transition">Scheduling Workspace</a>
            </div>
            <div class="flex items-center gap-4">
                 <button id="notifications-btn" class="text-gray-300 hover:text-indigo-400 transition text-xl relative hidden" title="Notifications"><i class="fa-solid fa-bell"></i><span id="notification-badge" class="notification-badge hidden"></span></button>
                 <button id="attendance-btn" class="text-gray-300 hover:text-indigo-400 transition text-xl hidden" title="Attendance Portal"><i class="fa-solid fa-fingerprint"></i></button>
                 <button id="tutorial-btn" class="text-gray-300 hover:text-indigo-400 transition text-xl" title="How to Use"><i class="fa-solid fa-circle-question"></i></button>
                 <button id="dark-mode-toggle" class="text-gray-300 hover:text-indigo-400 transition text-xl" title="Toggle Dark Mode"><i class="fa-solid fa-moon"></i></button>
                 <div id="auth-container" class="flex items-center gap-4">
                    <button id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md hover:shadow-lg">Login</button>
                    <div id="user-info-container" class="hidden items-center gap-3">
                        <span id="username-display" class="font-semibold text-white"></span>
                        <button id="logout-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">Logout</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero-bg text-white py-24 sm:py-32">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-5xl md:text-8xl font-extrabold font-poppins tracking-tight">Aca<span class="text-indigo-400">Dexa</span></h2>
                <h1 class="mt-4 text-3xl md:text-5xl font-bold tracking-tight">Intelligent Scheduling for Smart Campuses</h1>
                <p class="mt-6 text-lg md:text-xl max-w-3xl mx-auto text-gray-300">A modern platform for scheduling classes, managing resources, and resolving conflicts with AI-powered assistance and smart substitution.</p>
                <div class="mt-8 flex justify-center gap-4"><a href="#schedule-workspace" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition">Get Started</a></div>
            </div>
        </section>

        <section id="features" class="py-20 bg-white dark:bg-gray-900">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100">A Platform Built for Modern Education</h2>
                    <p class="mt-2 text-slate-500 dark:text-slate-400 max-w-2xl mx-auto">AcaDexa handles the complexities of academic scheduling with powerful new features.</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-8 rounded-xl">
                        <div class="bg-indigo-100 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-full h-12 w-12 flex items-center justify-center mb-4"><i class="fa-solid fa-right-left"></i></div>
                        <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Smart Substitution</h3>
                        <p class="text-slate-500 dark:text-slate-400">If a teacher is absent, the system notifies their colleague, allowing them to accept and automatically reschedule the class into their own timetable.</p>
                    </div>
                    <div class="feature-card p-8 rounded-xl">
                        <div class="bg-indigo-100 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-full h-12 w-12 flex items-center justify-center mb-4"><i class="fa-solid fa-shuffle"></i></div>
                        <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Dynamic Rescheduling</h3>
                        <p class="text-slate-500 dark:text-slate-400">Teachers can drag and drop classes to adjust their schedule. A "Shuffle" option can also randomize the entire week to find new arrangements.</p>
                    </div>
                    <div class="feature-card p-8 rounded-xl">
                        <div class="bg-indigo-100 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-full h-12 w-12 flex items-center justify-center mb-4"><i class="fa-solid fa-graduation-cap"></i></div>
                        <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Student View Portal</h3>
                        <p class="text-slate-500 dark:text-slate-400">A dedicated, view-only login for students shows the most up-to-date schedule, including class topics and credit details.</p>
                    </div>
                     <div class="feature-card p-8 rounded-xl">
                        <div class="bg-indigo-100 text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-full h-12 w-12 flex items-center justify-center mb-4"><i class="fa-solid fa-robot"></i></div>
                        <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">AI Scheduling Assistant</h3>
                        <p class="text-slate-500 dark:text-slate-400">Use the built-in chatbot to schedule new classes with natural language. The AI checks for conflicts before adding events to the calendar.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="schedule-workspace" class="py-20 bg-slate-100 dark:bg-gray-800/50">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100">Interactive Scheduling Workspace</h2>
                    <p id="workspace-subtitle" class="mt-2 text-slate-500 dark:text-slate-400 max-w-2xl mx-auto">Log in as a teacher to build your schedule. Drag classes from "Unscheduled" onto the calendar.</p>
                </div>
                
                 <div id="teacher-controls" class="bg-white dark:bg-gray-900/50 border border-slate-200 dark:border-gray-700 p-4 rounded-xl shadow-md mb-6 max-w-6xl mx-auto hidden">
                    <form id="add-class-form" class="grid sm:grid-cols-5 gap-4 items-end">
                        <input type="text" id="subject" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm dark:bg-gray-800 border-slate-300 dark:border-gray-600" placeholder="Subject Name" required>
                        <input type="text" id="topic" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm dark:bg-gray-800 border-slate-300 dark:border-gray-600" placeholder="Topic for Discussion" required>
                        <input type="text" id="room" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm dark:bg-gray-800 border-slate-300 dark:border-gray-600" placeholder="Room No." required>
                        <input type="number" id="credits" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm dark:bg-gray-800 border-slate-300 dark:border-gray-600" placeholder="Credits" required>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition w-full h-fit">Add to List</button>
                    </form>
                    <div class="flex justify-center mt-4">
                        <button id="shuffle-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition flex items-center gap-2"><i class="fa-solid fa-shuffle"></i> Shuffle Schedule</button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-12 gap-6">
                    <div id="unscheduled-container" class="lg:col-span-2 hidden">
                         <h3 class="font-bold text-center text-slate-700 dark:text-slate-300 mb-2">Unscheduled Classes</h3>
                         <div id="unscheduled-list" class="bg-white dark:bg-gray-800/50 border border-slate-200 dark:border-gray-700 p-4 rounded-xl shadow-lg min-h-[100px] space-y-2"></div>
                    </div>
                    <div id="calendar-wrapper" class="lg:col-span-12 bg-white dark:bg-gray-900/50 border border-slate-200 dark:border-gray-700 p-4 rounded-2xl shadow-lg">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-gray-400">
        <div class="container mx-auto px-6 py-12 border-t border-gray-700 pt-8 text-center text-sm">
            <p>&copy; 2025 AcaDexa. All rights reserved. A Smart India Hackathon Project.</p>
        </div>
    </footer>

    <div id="modals-container"></div>
    <button id="ask-ai-btn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg text-2xl z-40 hidden"><i class="fa-solid fa-robot"></i></button>
    <div id="toast" class="toast fixed bottom-6 left-1/2 -translate-x-1/2 bg-red-600 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 z-[70]"><p id="toast-message"></p></div>

    <script type="text/template" id="modals-template">
        <div id="class-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center opacity-0 invisible">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300 relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 dark:hover:text-white hover:text-slate-800 text-2xl">&times;</button>
                <h3 id="class-modal-title" class="text-2xl font-bold mb-2 text-slate-800 dark:text-white"></h3>
                <p id="class-modal-time" class="text-slate-500 dark:text-slate-400 mb-6"></p>
                <div class="space-y-4">
                    <div class="flex items-center gap-4"><i class="fa-solid fa-user-tie w-4 text-center text-indigo-400"></i><span id="class-modal-prof"></span></div>
                    <div class="flex items-center gap-4"><i class="fa-solid fa-building w-4 text-center text-indigo-400"></i><span id="class-modal-room"></span></div>
                    <div class="flex items-center gap-4"><i class="fa-solid fa-star w-4 text-center text-indigo-400"></i><span id="class-modal-credits"></span></div>
                    <div class="flex items-start gap-4"><i class="fa-solid fa-lightbulb w-4 text-center text-indigo-400 pt-1"></i><div><span class="font-bold">Topic:</span> <span id="class-modal-topic"></span></div></div>
                </div>
                 <div id="teacher-action-buttons" class="mt-6 pt-6 border-t border-slate-200 dark:border-gray-700 flex gap-2">
                    <button id="delete-class-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Delete Class</button>
                </div>
            </div>
        </div>

        <div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center opacity-0 invisible">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300 relative">
                 <button class="close-modal-btn absolute top-4 right-4 text-slate-500 dark:hover:text-white hover:text-slate-800 text-2xl">&times;</button>
                 <h3 class="text-2xl font-bold mb-6 text-center text-slate-800 dark:text-white">Login</h3>
                 <form id="auth-form"><div class="space-y-4"><input type="text" id="auth-username" placeholder="Username" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required><div class="relative"><input type="password" id="auth-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required><button type="button" id="password-toggle-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400"><i class="fa-solid fa-eye"></i></button></div></div><p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p><button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Login</button></form>
            </div>
        </div>

        <div id="attendance-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center opacity-0 invisible">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300 relative">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 dark:hover:text-white hover:text-slate-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center text-slate-800 dark:text-white">Attendance Portal</h3>
                <p class="text-center text-slate-500 mb-6">Simulate your biometric check-in for today's classes.</p>
                <div class="flex flex-col gap-4">
                    <button id="clock-in-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-check-circle"></i> Clock In (Present)</button>
                    <button id="mark-absent-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-user-clock"></i> Mark Absent (Trigger Sub)</button>
                </div>
            </div>
        </div>

        <div id="notifications-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center opacity-0 invisible">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-lg w-full transform scale-95 transition-transform duration-300">
                <button class="close-modal-btn absolute top-4 right-4 text-slate-500 dark:hover:text-white hover:text-slate-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Your Notifications</h3>
                <div id="notifications-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
        </div>

        <div id="tutorial-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center opacity-0 invisible">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full transform scale-95 transition-transform duration-300 relative">
                 <button class="close-modal-btn absolute top-4 right-4 text-slate-500 dark:hover:text-white hover:text-slate-800 text-2xl">&times;</button>
                 <h3 class="text-2xl font-bold mb-6 text-center text-slate-800 dark:text-white">How to Use AcaDexa</h3>
                 <div class="space-y-4 text-slate-600 dark:text-slate-300">
                    <p><strong>1. Login:</strong> Use the Login button. Teachers can edit, students can only view.</p>
                    <p><strong>2. Add & Schedule (Teachers):</strong> Use the form to add a class to the "Unscheduled" list, then drag it onto the calendar.</p>
                    <p><strong>3. Mark Attendance (Teachers):</strong> Use the <i class="fa-solid fa-fingerprint"></i> icon. Marking yourself absent will ask your colleague to cover for you.</p>
                    <p><strong>4. Handle Substitutions (Teachers):</strong> Check the <i class="fa-solid fa-bell"></i> icon for substitution requests. Accepting will auto-reschedule the class for you.</p>
                    <p><strong>5. Use the AI Bot (Teachers):</strong> Click the <i class="fa-solid fa-robot"></i> icon to schedule classes using natural language.</p>
                </div>
            </div>
        </div>
        
        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center opacity-0 invisible">
             <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-lg w-full h-[70vh] flex flex-col transform scale-95 transition-transform duration-300">
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold text-slate-800 dark:text-white">AI Assistant</h3><button class="close-modal-btn text-slate-500 hover:text-slate-800 dark:hover:text-white text-2xl">&times;</button></div>
                <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto"><div class="flex justify-start"><div class="p-3 rounded-lg bg-slate-200 dark:bg-gray-700 text-slate-800 dark:text-slate-200">Hello! Ask me to 'schedule a class' to begin.</div></div></div>
                <div class="p-4 border-t dark:border-gray-700"><form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" placeholder="e.g., Schedule Physics in Room 101..." class="flex-grow rounded-md shadow-sm sm:text-sm dark:bg-gray-700 border-slate-300 dark:border-gray-600"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded-lg transition"><i class="fa-solid fa-paper-plane"></i></button></form></div>
            </div>
        </div>
    </script>

    <script type="module">
        // Firebase Imports (replace with your actual config)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, updateDoc, addDoc, getDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual Firebase API key
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- GLOBAL STATE ---
        let currentUser = null; 
        let scheduleData = {};
        let scheduleUnsubscribe = null;
        let notificationsUnsubscribe = null;
        let calendar = null;
        let conversationState = {};

        // --- CORE DATA & CONFIG ---
        const userCredentials = {
            "Kashy": "math123",
            "ZapAlert": "sci123",
            "yokesh": "wtf"
        };
        const userRoles = {
            "Kashy": "teacher",
            "ZapAlert": "teacher",
            "yokesh": "student"
        };
        
        // --- DATA & STATE MANAGEMENT ---
        function loadDefaultSchedule() {
             scheduleData = {
                "c1": { id: "c1", subject: "Calculus I", prof: "Kashy", room: "101", credits: 4, topic: "Introduction to Derivatives", color: "#ec4899", start: "T09:00:00", day: 1 },
                "c2": { id: "c2", subject: "Quantum Physics", prof: "ZapAlert", room: "102", credits: 4, topic: "Wave-Particle Duality", color: "#10b981", start: "T10:00:00", day: 1 },
                "c3": { id: "c3", subject: "Linear Algebra", prof: "Kashy", room: "101", credits: 3, topic: "Vector Spaces", color: "#ec4899", start: "T11:00:00", day: 2 },
                "c4": { id: "c4", subject: "Chemical Engineering", prof: "ZapAlert", room: "Lab A", credits: 4, topic: "Thermodynamics Basics", color: "#10b981", start: "T13:00:00", day: 3 },
                "c5": { id: "c5", subject: "Geometry", prof: "Kashy", room: "202", credits: 3, topic: "Euclidean Proofs", color: "#ec4899", start: "T09:00:00", day: 4 },
                "c6": { id: "c6", subject: "Astrophysics", prof: "ZapAlert", room: "102", credits: 3, topic: "Stellar Evolution", color: "#10b981", start: "T14:00:00", day: 5 },
                "unscheduled": [
                    { id: "c7", subject: "Statistics", prof: "Kashy", room: "202", credits: 3, topic: "Probability Distributions", color: "#f97316" },
                    { id: "c8", subject: "Robotics", prof: "ZapAlert", room: "Lab B", credits: 4, topic: "Intro to Kinematics", color: "#3b82f6" }
                ]
            };
            renderAll();
        }

        async function saveScheduleToFirestore() {
            if (!currentUser) return;
            // All teachers edit the same central schedule document
            const scheduleRef = doc(db, "schedules", "main_schedule");
            try {
                // Remove calendar event objects before saving
                const cleanScheduleData = JSON.parse(JSON.stringify(scheduleData));
                Object.values(cleanScheduleData).forEach(item => {
                    if (item && typeof item === 'object' && !Array.isArray(item)) {
                        delete item.event;
                    }
                });
                await setDoc(scheduleRef, { data: JSON.stringify(cleanScheduleData) });
            } catch (error) { console.error("Error saving schedule: ", error); }
        }

        function listenToSchedule() {
            if (scheduleUnsubscribe) scheduleUnsubscribe();
            const scheduleRef = doc(db, "schedules", "main_schedule");
            scheduleUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().data) {
                    scheduleData = JSON.parse(docSnap.data().data);
                } else {
                    loadDefaultSchedule();
                    // Save the default if it doesn't exist
                    if (currentUser?.role === 'teacher') saveScheduleToFirestore();
                }
                renderAll();
            }, (error) => console.error("Snapshot listener error:", error));
        }

        function listenToNotifications() {
            if (!currentUser || notificationsUnsubscribe) return;
            const q = query(collection(db, "notifications"), where("toUser", "==", currentUser.name), where("status", "==", "pending"));
            notificationsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const notifications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotifications(notifications);
            });
        }
        
        function convertScheduleToEvents() {
            const events = [];
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            Object.values(scheduleData).forEach(item => {
                if(Array.isArray(item) || !item.day) return;
                
                const eventDate = new Date();
                eventDate.setDate(today.getDate() - dayOfWeek + item.day);
                const [hours, minutes] = item.start.substring(1).split(':');
                eventDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                events.push({
                    id: item.id,
                    title: item.isAbsent ? `[ABSENT] ${item.subject}` : item.subject,
                    start: eventDate,
                    end: new Date(eventDate.getTime() + 50 * 60000),
                    color: item.color,
                    extendedProps: { ...item }
                });
            });
            return events;
        }

        // --- UI RENDERING & INITIALIZATION ---
        function renderAll() {
            renderUnscheduled();
            renderCalendar();
            detectAllConflicts();
        }

        function renderCalendar() {
            if (!calendar) return;
            calendar.removeAllEvents();
            calendar.addEventSource(convertScheduleToEvents());
        }

        function renderUnscheduled() {
            const listEl = document.getElementById('unscheduled-list');
            if(!listEl) return;
            listEl.innerHTML = '';
            (scheduleData.unscheduled || []).filter(c => c.prof === currentUser?.name).forEach(classData => {
                const el = document.createElement('div');
                el.className = 'unscheduled-item p-2 rounded-md text-sm';
                el.style.backgroundColor = classData.color + '33';
                el.style.borderLeft = `4px solid ${classData.color}`;
                el.dataset.classinfo = JSON.stringify(classData);
                el.innerHTML = `<strong class="font-bold text-slate-800 dark:text-slate-100">${classData.subject}</strong><div class="text-xs text-slate-600 dark:text-slate-300">${classData.topic}</div>`;
                listEl.appendChild(el);
            });
            new FullCalendar.Draggable(listEl, {
                itemSelector: '.unscheduled-item',
                eventData: (eventEl) => ({
                    ...JSON.parse(eventEl.dataset.classinfo),
                    title: JSON.parse(eventEl.dataset.classinfo).subject,
                    duration: '00:50'
                })
            });
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if(!calendarEl) return;
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
                allDaySlot: false, 
                editable: false, // Controlled by user role
                droppable: true,
                slotMinTime: '08:00:00',
                slotMaxTime: '18:00:00', 
                eventReceive: handleEventReceive,
                eventDrop: handleEventDrop, 
                eventClick: handleEventClick
            });
            calendar.render();
        }

        function renderNotifications(notifications) {
            const badge = document.getElementById('notification-badge');
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';

            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.classList.remove('hidden');
                notifications.forEach(noti => {
                    const el = document.createElement('div');
                    el.className = 'p-3 bg-slate-100 dark:bg-gray-700 rounded-lg';
                    if (noti.type === 'substitution_request') {
                        const classInfo = noti.classToCover;
                        el.innerHTML = `<p class="mb-2"><strong>${classInfo.prof}</strong> is absent. Can you cover <strong>${classInfo.subject}</strong>?</p><p class="text-sm text-slate-500 mb-2">Original time: ${new Date(noti.createdAt.seconds*1000).toLocaleDateString([], {weekday:'short'})} at ${classInfo.start.substring(1,6)}</p><div class="flex gap-2"><button data-noti-id="${noti.id}" class="accept-sub-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Accept & Reschedule</button><button data-noti-id="${noti.id}" class="decline-sub-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Decline</button></div>`;
                    }
                    list.appendChild(el);
                });
            } else {
                badge.classList.add('hidden');
                list.innerHTML = '<p class="text-slate-500 text-center">No new notifications.</p>';
            }
        }
        
        // --- EVENT HANDLERS & LOGIC ---
        function setupEventListeners() {
            document.getElementById('add-class-form').addEventListener('submit', handleAddClass);
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
            document.getElementById('tutorial-btn').addEventListener('click', () => showModal('tutorial-modal'));
            document.getElementById('login-btn').addEventListener('click', () => showModal('auth-modal'));
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('ask-ai-btn').addEventListener('click', () => showModal('ai-chat-modal'));
            document.getElementById('attendance-btn').addEventListener('click', () => showModal('attendance-modal'));
            document.getElementById('clock-in-btn').addEventListener('click', () => { showToast("You are clocked in for today!", "success"); hideModal('attendance-modal'); });
            document.getElementById('mark-absent-btn').addEventListener('click', handleMarkAbsent);
            document.getElementById('shuffle-btn').addEventListener('click', handleShuffle);
            
            document.addEventListener('click', (e) => {
                if (e.target.closest('.close-modal-btn')) hideModal(e.target.closest('.modal').id);
                if (e.target.closest('#delete-class-btn')) handleDeleteClass(e.target.closest('#delete-class-btn').dataset.classId);
                if (e.target.closest('.accept-sub-btn')) handleSubstitutionResponse(e.target.closest('.accept-sub-btn').dataset.notiId, 'accepted');
                if (e.target.closest('.decline-sub-btn')) handleSubstitutionResponse(e.target.closest('.decline-sub-btn').dataset.notiId, 'declined');
            });

            document.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.id === 'auth-form') handleAuthSubmit(e);
                if (e.target.id === 'chat-form') handleChatSubmit(e);
            });
        }

        function handleEventClick(info) {
            const props = info.event.extendedProps;
            document.getElementById('class-modal-title').textContent = props.subject;
            const timeFormat = new Intl.DateTimeFormat('en', { hour: 'numeric', minute: 'numeric' });
            document.getElementById('class-modal-time').textContent = `${info.event.start.toLocaleDateString('en-US', { weekday: 'long' })}, ${timeFormat.format(info.event.start)}`;
            document.getElementById('class-modal-prof').textContent = props.prof;
            document.getElementById('class-modal-room').textContent = `Room ${props.room}`;
            document.getElementById('class-modal-credits').textContent = `${props.credits} Credits`;
            document.getElementById('class-modal-topic').textContent = props.topic;
            document.getElementById('delete-class-btn').dataset.classId = props.id;
            
            const teacherActions = document.getElementById('teacher-action-buttons');
            teacherActions.style.display = (currentUser?.role === 'teacher' && currentUser.name === props.prof) ? 'flex' : 'none';
            showModal('class-details-modal');
        }
        
        async function handleDeleteClass(classId) {
            if (!classId || !scheduleData[classId]) return;
            if (currentUser?.name !== scheduleData[classId].prof) {
                showToast("You can only delete your own classes.", "error"); return;
            }
            delete scheduleData[classId];
            await saveScheduleToFirestore();
            hideModal('class-details-modal');
            showToast("Class deleted.", "success");
        }
        
        async function handleMarkAbsent() {
            if (!currentUser) return;
            const today = new Date().getDay();
            const teacherClassesToday = Object.values(scheduleData).filter(c => c.prof === currentUser.name && c.day === today && !c.isAbsent);
            if (teacherClassesToday.length === 0) {
                showToast("You have no more classes to mark absent today.", "info");
                hideModal('attendance-modal'); return;
            }
            teacherClassesToday.forEach(c => c.isAbsent = true);

            const otherTeacher = Object.keys(userRoles).find(name => userRoles[name] === 'teacher' && name !== currentUser.name);
            for (const classToCover of teacherClassesToday) {
                await addDoc(collection(db, "notifications"), {
                    toUser: otherTeacher,
                    fromUser: currentUser.name,
                    type: 'substitution_request',
                    classToCover: classToCover,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
            }
            await saveScheduleToFirestore();
            showToast(`Absence marked. ${otherTeacher} has been notified.`, "success");
            hideModal('attendance-modal');
        }

        async function handleSubstitutionResponse(notiId, response) {
            const notiRef = doc(db, "notifications", notiId);
            const notiSnap = await getDoc(notiRef);
            if (!notiSnap.exists()) return;
            const notiData = notiSnap.data();

            if (response === 'accepted') {
                const subClass = {
                    ...notiData.classToCover,
                    id: 'sub_' + notiData.classToCover.id,
                    prof: currentUser.name,
                    isAbsent: false,
                    isSub: true,
                    topic: `(SUB) ${notiData.classToCover.topic}`
                };
                delete subClass.day;
                delete subClass.start;

                // Find the next available slot for the current teacher
                const { day, start } = findNextAvailableSlot();
                if (day !== null) {
                    subClass.day = day;
                    subClass.start = start;
                    scheduleData[subClass.id] = subClass;
                    await saveScheduleToFirestore();
                    showToast("Substitution accepted! Class added to your schedule.", "success");
                } else {
                    showToast("Substitution accepted, but no free slots found in your schedule!", "error");
                }
            }
            await updateDoc(notiRef, { status: response });
            hideModal('notifications-modal');
        }

        function findNextAvailableSlot() {
            const today = new Date();
            const currentDay = today.getDay();
            const currentHour = today.getHours();
            const scheduledSlots = new Set();
            Object.values(scheduleData).forEach(c => {
                if(c.day && c.start && c.prof === currentUser.name) {
                    scheduledSlots.add(`${c.day}-${c.start}`);
                }
            });

            for (let day = currentDay; day <= 5; day++) { // Mon-Fri
                for (let hour = 8; hour < 17; hour++) {
                    if (day === currentDay && hour <= currentHour) continue; // Skip past times
                    const timeString = `T${String(hour).padStart(2, '0')}:00:00`;
                    if (!scheduledSlots.has(`${day}-${timeString}`)) {
                        return { day, start: timeString };
                    }
                }
            }
            return { day: null, start: null }; // No slot found
        }
        
        async function handleEventReceive(info) {
            if (currentUser?.role !== 'teacher') {
                showToast("Only teachers can schedule classes.", "error");
                info.revert(); return;
            }
            const props = info.event.extendedProps;
            scheduleData[props.id] = { ...props, day: info.event.start.getDay(), start: 'T' + info.event.start.toTimeString().substring(0, 8) };
            scheduleData.unscheduled = scheduleData.unscheduled.filter(c => c.id !== props.id);
            await saveScheduleToFirestore();
        }

        async function handleEventDrop(info) {
            if (currentUser?.role !== 'teacher') { info.revert(); return; }
            const classId = info.event.id;
            scheduleData[classId] = { ...scheduleData[classId], day: info.event.start.getDay(), start: 'T' + info.event.start.toTimeString().substring(0, 8) };
            await saveScheduleToFirestore();
        }
        
        function detectAllConflicts() {
            if(!calendar) return;
            calendar.getEvents().forEach(e => e.setProp('classNames', e.extendedProps.isAbsent ? ['absent'] : []));
            const scheduled = Object.values(scheduleData).filter(c => c && c.day && !c.isAbsent);
            const conflictsFound = new Set();
            const slots = {};

            scheduled.forEach(c => {
                const key = `${c.day}-${c.start}`;
                slots[key] = slots[key] || { profs: [], rooms: [] };
                slots[key].profs.push({prof: c.prof, id: c.id});
                slots[key].rooms.push({room: c.room, id: c.id});
            });

            Object.values(slots).forEach(slot => {
                const profCounts = slot.profs.reduce((acc, p) => ({...acc, [p.prof]: (acc[p.prof] || 0) + 1}), {});
                const roomCounts = slot.rooms.reduce((acc, r) => ({...acc, [r.room]: (acc[r.room] || 0) + 1}), {});
                slot.profs.forEach(p => { if (profCounts[p.prof] > 1) conflictsFound.add(p.id); });
                slot.rooms.forEach(r => { if (roomCounts[r.room] > 1) conflictsFound.add(r.id); });
            });

            if (conflictsFound.size > 0) conflictsFound.forEach(id => calendar.getEventById(id)?.setProp('classNames', ['conflict']));
        }
        
        async function handleAddClass(e) {
            e.preventDefault();
            if (currentUser?.role !== 'teacher') return;
            const form = e.target;
            if (!scheduleData.unscheduled) scheduleData.unscheduled = [];
            const newClass = { 
                id: 'c' + Date.now(), subject: form.subject.value, prof: currentUser.name, room: form.room.value,
                credits: parseInt(form.credits.value), topic: form.topic.value, 
                color: currentUser.name === 'Kashy' ? '#ec4899' : '#10b981'
            };
            scheduleData.unscheduled.push(newClass);
            await saveScheduleToFirestore();
            form.reset();
        }

        function handleShuffle() {
            if (currentUser?.role !== 'teacher') return;
            const myScheduledClasses = Object.values(scheduleData).filter(c => c.day && c.prof === currentUser.name);
            const availableSlots = [];
            for (let day = 1; day <= 5; day++) { // Mon-Fri
                for (let hour = 8; hour < 17; hour++) {
                    availableSlots.push({ day, start: `T${String(hour).padStart(2, '0')}:00:00` });
                }
            }
             // Simple shuffle algorithm
            for (let i = availableSlots.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableSlots[i], availableSlots[j]] = [availableSlots[j], availableSlots[i]];
            }
            myScheduledClasses.forEach((c, index) => {
                if (availableSlots[index]) {
                    c.day = availableSlots[index].day;
                    c.start = availableSlots[index].start;
                }
            });
            saveScheduleToFirestore();
            showToast("Your schedule has been shuffled!", "success");
        }

        // --- AUTH & STATE CHANGES ---
        function updateUIForAuthState() {
            const isTeacher = currentUser?.role === 'teacher';
            const isStudent = currentUser?.role === 'student';
            
            document.getElementById('login-btn').style.display = currentUser ? 'none' : 'block';
            document.getElementById('user-info-container').style.display = currentUser ? 'flex' : 'none';
            document.getElementById('username-display').textContent = currentUser?.name || '';
            
            document.getElementById('teacher-controls').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('unscheduled-container').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('ask-ai-btn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('notifications-btn').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('attendance-btn').style.display = isTeacher ? 'block' : 'none';

            const calendarWrapper = document.getElementById('calendar-wrapper');
            calendarWrapper.className = `lg:col-span-${isTeacher ? '10' : '12'} bg-white dark:bg-gray-900/50 border border-slate-200 dark:border-gray-700 p-4 rounded-2xl shadow-lg`;
            document.getElementById('workspace-subtitle').textContent = isStudent ? 'Viewing the official weekly schedule.' : 'Log in as a teacher to build your schedule.';

            calendar?.setOption('editable', isTeacher);
            window.dispatchEvent(new Event('resize')); // Recalculate calendar size
        }
        
        function handleAuthSubmit(e) {
             const username = document.getElementById('auth-username').value;
             const password = document.getElementById('auth-password').value;
             const errorEl = document.getElementById('auth-error');
             errorEl.textContent = '';

             if (userCredentials[username] && userCredentials[username] === password) {
                currentUser = { name: username, role: userRoles[username] };
                updateUIForAuthState();
                listenToSchedule();
                if(currentUser.role === 'teacher') listenToNotifications();
                hideModal('auth-modal');
             } else {
                errorEl.textContent = "Invalid username or password.";
             }
        }

        function handleLogout() {
            if(scheduleUnsubscribe) scheduleUnsubscribe();
            if(notificationsUnsubscribe) notificationsUnsubscribe();
            scheduleUnsubscribe = null; notificationsUnsubscribe = null;
            currentUser = null;
            updateUIForAuthState(); 
            loadDefaultSchedule();
        }

        // --- AI CHATBOT --- (Kept as is, but now respects teacher role)
        function resetConversationState() { conversationState = { active: false, stage: null, collectedInfo: {} }; }
        function appendChatMessage(message, sender) {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = `p-3 rounded-lg max-w-[80%] ${sender === 'user' ? 'bg-indigo-600 text-white self-end' : 'bg-slate-200 dark:bg-gray-700 self-start'}`;
            msgDiv.innerHTML = message;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        async function handleChatSubmit(e) {
            const input = document.getElementById('chat-input');
            const userInput = input.value.trim();
            if (!userInput || currentUser?.role !== 'teacher') return;
            appendChatMessage(userInput, 'user'); input.value = '';
            // Simplified AI logic for brevity. This can be expanded.
            if (!conversationState.active) {
                if (userInput.toLowerCase().includes('schedule')) {
                    conversationState.active = true;
                    conversationState.stage = 'get_subject';
                    appendChatMessage("OK. What's the subject name?", 'ai');
                } else { appendChatMessage("I can help you schedule a class.", 'ai'); }
            } else if (conversationState.stage === 'get_subject') {
                const subject = userInput;
                const newClass = { id: 'c' + Date.now(), subject, prof: currentUser.name, room: 'TBD', credits: 3, topic: 'AI Scheduled', color: '#8b5cf6' };
                if (!scheduleData.unscheduled) scheduleData.unscheduled = [];
                scheduleData.unscheduled.push(newClass);
                await saveScheduleToFirestore();
                appendChatMessage(`I've added <strong>${subject}</strong> to the unscheduled list for you.`, 'ai');
                resetConversationState();
            }
        }

        // --- UTILITIES ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            document.querySelector('#dark-mode-toggle i').className = document.documentElement.classList.contains('dark') ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
        function showToast(message, type = "error") {
            const toast = document.getElementById('toast');
            toast.querySelector('p').textContent = message;
            toast.className = `toast fixed bottom-6 left-1/2 -translate-x-1/2 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 z-[70] ${type === 'success' ? 'bg-green-600' : (type === 'info' ? 'bg-sky-600' : 'bg-red-600')}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }
        function showModal(id) { 
            const modal = document.getElementById(id); if(!modal) return;
            modal.classList.remove('hidden', 'invisible');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div:first-child').classList.remove('scale-95'); }, 10);
        }
        function hideModal(id) { 
            const modal = document.getElementById(id); if(!modal) return;
            modal.classList.add('opacity-0'); modal.querySelector('div:first-child').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden', 'invisible'); }, 300);
        }
        
        // --- FINAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modals-container').innerHTML = document.getElementById('modals-template').innerHTML;
            initializeCalendar();
            setupEventListeners();
            loadDefaultSchedule();
            resetConversationState();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcaDexa - Advanced Scheduling Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            @apply bg-slate-100 text-slate-800 dark:bg-gray-900 dark:text-slate-200; 
            transition: background-color 0.3s; 
        }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        body {
            background-color: #f1f5f9;
            background-image:
                radial-gradient(circle at 15% 15%, rgba(79, 70, 229, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            transition: background-color 0.4s ease-in-out;
        }
        .dark body {
            background-color: #111827;
            background-image:
                radial-gradient(circle at 15% 15%, rgba(79, 70, 229, 0.1) 0%, transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 40%);
        }

        .modal { transition: opacity 0.3s, visibility 0.3s; @apply invisible opacity-0; }
        .modal.visible { @apply visible opacity-100; }
        .modal-content { transition: transform 0.3s ease-out; transform: translateY(20px) scale(0.98); }
        .modal.visible .modal-content { transform: translateY(0) scale(1); }
        .toast { transition: opacity 0.3s, transform 0.3s; }
        .btn-icon { @apply w-5 h-5; }
        
        :root { --fc-border-color: #e2e8f0; --fc-neutral-bg-color: rgba(241, 245, 249, 0.5); --fc-event-text-color: #fff; --fc-page-bg-color: transparent;}
        html.dark { --fc-border-color: #374151; --fc-neutral-bg-color: rgba(31, 41, 55, 0.5); --fc-page-bg-color: transparent;}
        .fc .fc-toolbar-title { @apply text-2xl font-bold font-poppins; }
        .fc .fc-button { @apply bg-indigo-600 border-indigo-600 hover:bg-indigo-700 text-white transition-colors duration-200; }
        .fc .fc-button-primary:disabled { @apply bg-indigo-400 dark:bg-indigo-800; }
        .fc .fc-daygrid-day.fc-day-today { @apply bg-indigo-50 dark:bg-indigo-900/20; }
        .fc-event { @apply text-xs border-0 cursor-pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .fc-event:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .fc-event.absent { @apply opacity-50 line-through bg-gray-500; }
        
        .fc .fc-timegrid-slot.heatmap-1 { background-color: rgba(99, 102, 241, 0.1); }
        .fc .fc-timegrid-slot.heatmap-2 { background-color: rgba(99, 102, 241, 0.2); }
        .dark .fc .fc-timegrid-slot.heatmap-1 { background-color: rgba(99, 102, 241, 0.15); }
        .dark .fc .fc-timegrid-slot.heatmap-2 { background-color: rgba(99, 102, 241, 0.25); }
        .toggle-checkbox:checked + .toggle-label { @apply bg-indigo-600; }

        #scanner-animation.scanning .inner-circle { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.7; } 50% { transform: scale(1); opacity: 1; } }

        @media print {
            body * { visibility: hidden; }
            #calendar-container, #calendar-container * { visibility: visible; }
            #schedule-controls, #schedule-controls *, header, main > h2 { visibility: hidden; }
            #calendar-container { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40 border-b border-slate-200 dark:border-gray-700">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold tracking-wider font-poppins">Aca<span class="text-indigo-500">Dexa</span></div>
            <div class="flex items-center gap-2 sm:gap-4">
                 <button id="notifications-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition relative hidden" title="Notifications"><i data-lucide="bell"></i><span id="notification-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden"></span></button>
                 <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition" title="Toggle Dark Mode"><i data-lucide="moon"></i></button>
                 <div id="auth-container" class="flex items-center gap-2">
                    <button id="student-login-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm">Student Login</button>
                    <button id="staff-portal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm">Staff Portal</button>
                 </div>
                 <div id="user-info-container" class="hidden items-center gap-3">
                    <span id="username-display" class="font-semibold hidden sm:block"></span>
                    <button id="logout-btn" class="p-2 rounded-full bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition" title="Logout"><i data-lucide="log-out" class="btn-icon"></i></button>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto p-4 sm:p-6">
        <div id="welcome-screen" class="hidden">
             <div class="text-center py-12"><h1 class="text-5xl md:text-7xl font-extrabold font-poppins tracking-tight">Welcome to Aca<span class="text-indigo-500">Dexa</span></h1><p class="mt-4 text-lg text-slate-600 dark:text-slate-300">Your all-in-one solution for intelligent academic scheduling.</p>
                <div class="mt-8 max-w-lg mx-auto bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">Test Accounts</h2>
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-gray-700"><tr><th class="p-2 rounded-tl-lg">Role</th><th class="p-2">Email</th><th class="p-2 rounded-tr-lg">Password</th></tr></thead>
                        <tbody>
                            <tr class="border-b dark:border-gray-600"><td class="p-2">Staff</td><td class="p-2">kashy@acadexa.com</td><td class="p-2">password123</td></tr>
                            <tr class="border-b dark:border-gray-600"><td class="p-2">Staff</td><td class="p-2">anna@acadexa.com</td><td class="p-2">password123</td></tr>
                            <tr><td class="p-2">Student</td><td class="p-2">yokesh@acadexa.com</td><td class="p-2">student123</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="app-wrapper" class="hidden">
            <div id="staff-dashboard" class="hidden"></div>
            <div id="student-dashboard" class="hidden"></div>
            
            <div id="schedule-view" class="hidden mt-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div id="staff-schedule-tools" class="lg:col-span-1 hidden bg-white dark:bg-gray-800/50 p-4 rounded-xl shadow-md">
                        <h3 class="font-bold text-lg mb-4">Scheduling Tools</h3>
                        <div id="available-subjects" class="space-y-2">
                            <h4 class="font-semibold text-sm mb-2 text-slate-500">Drag a Subject to the Calendar</h4>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                        <div class="bg-white dark:bg-gray-800/50 p-4 sm:p-6 rounded-xl shadow-md">
                             <div id="schedule-controls" class="flex flex-wrap gap-4 justify-between items-center mb-6">
                                <select id="schedule-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                                <div id="staff-schedule-filters" class="flex items-center gap-2 hidden">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="layers" class="w-4 h-4 text-slate-500"></i>
                                        <select id="staff-view-selector" class="p-2 rounded-md bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label for="heatmap-toggle" class="text-sm font-medium mr-2">Heatmap</label>
                                        <div class="relative inline-block w-10 align-middle"><input type="checkbox" id="heatmap-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="heatmap-toggle" class="toggle-label block h-6 rounded-full bg-slate-300 dark:bg-gray-600 cursor-pointer"></label></div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="print-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2" title="Print Schedule"><i data-lucide="printer"></i> <span class="hidden sm:inline">Print</span></button>
                                    <button id="download-btn" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-700 flex items-center gap-2" title="Download as ICS"><i data-lucide="download"></i> <span class="hidden sm:inline">Download</span></button>
                                </div>
                            </div>
                            <div id="calendar-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button id="ask-ai-btn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg z-40 hidden animate-bounce hover:animate-none"><i data-lucide="bot" class="w-8 h-8"></i></button>
    <div id="toast" class="toast fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform -translate-y-10 z-[90]"><p id="toast-message"></p></div>
    
    <div id="modals-container"></div>
    <script type="text/template" id="modals-template">
        <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-sm w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 id="login-title" class="text-2xl font-bold mb-6 text-center font-poppins">Login</h3><form id="auth-form"><div class="space-y-4"><input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" required><input type="password" id="auth-password" placeholder="Password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" required></div><p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p><button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Login</button></form></div></div>
        <div id="staff-portal-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-6 text-center font-poppins">Staff Portal</h3><div class="flex flex-col gap-4"><button id="open-dashboard-btn" class="w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg text-lg flex items-center justify-center gap-2 transition"><i data-lucide="layout-dashboard"></i> View Dashboard</button><button id="open-attendance-portal-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg text-lg flex items-center justify-center gap-2 transition"><i data-lucide="fingerprint"></i> Attendance Portal</button></div></div></div>
        <div id="attendance-portal-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-4 text-center">Biometric Attendance Portal</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="text-center"><h4 class="font-bold mb-4">Scan to Verify Presence</h4><div id="scanner-animation" class="w-40 h-40 mx-auto flex items-center justify-center border-4 border-slate-300 dark:border-gray-600 rounded-full p-2"><div class="inner-circle w-32 h-32 bg-indigo-500 rounded-full flex items-center justify-center text-white"><i data-lucide="fingerprint" class="w-16 h-16"></i></div></div><p id="scanner-status" class="mt-4 h-6 font-semibold"></p><button id="scan-biometric-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed">Scan Fingerprint</button></div><div><h4 class="font-bold mb-4">Live Staff Status (<span id="current-time"></span>)</h4><div id="staff-status-dashboard" class="space-y-2 h-56 overflow-y-auto pr-2"></div></div></div></div></div>
        <div id="class-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-md w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 id="class-modal-title" class="text-2xl font-bold"></h3><p id="class-modal-time" class="text-slate-500 mb-4"></p><div class="space-y-3 border-t dark:border-gray-700 pt-4"><div class="flex items-center gap-3"><i data-lucide="user" class="btn-icon text-indigo-500"></i><span id="class-modal-prof"></span></div><div class="flex items-center gap-3"><i data-lucide="map-pin" class="btn-icon text-indigo-500"></i><span id="class-modal-room"></span></div><div class="flex items-center gap-3"><i data-lucide="star" class="btn-icon text-indigo-500"></i><span id="class-modal-credits"></span></div><div id="notes-container" class="border-t dark:border-gray-700 pt-3 mt-3"><h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="notebook-text"></i>Lecture Notes</h4><div id="class-modal-notes-content" class="text-sm"></div></div><div id="action-container" class="mt-4 flex flex-col gap-2"></div></div></div></div>
        <div id="notifications-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 class="text-2xl font-bold mb-4 font-poppins">Notifications & Debts</h3><div class="border-b dark:border-gray-700 pb-2 mb-2"><h4 class="font-bold flex items-center gap-2 mb-2"><i data-lucide="arrow-left-right" class="text-indigo-500"></i>Pending Class Debts</h4><div id="class-debt-list" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div></div><div><h4 class="font-bold flex items-center gap-2 mb-2"><i data-lucide="alert-circle" class="text-amber-500"></i>System Alerts</h4><div id="alert-list" class="text-sm"></div></div></div></div>
        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-end justify-center sm:justify-end p-4 sm:p-6"><div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md h-[70vh] flex flex-col"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="bot" class="text-indigo-500"></i> AcaDexi Assistant</h3><button class="close-modal-btn text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button></div><div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col"></div><div class="p-4 border-t dark:border-gray-700"><form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" placeholder="Ask 'schedule a class'..." class="flex-grow p-2 rounded-md dark:bg-gray-700 border-slate-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 rounded-lg transition"><i data-lucide="send"></i></button></form></div></div></div>
        <div id="student-attendance-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[90] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full relative"><button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-indigo-500 transition"><i data-lucide="x"></i></button><h3 id="student-attendance-title" class="text-2xl font-bold mb-4 font-poppins">Mark Student Attendance</h3><div id="student-list-container" class="space-y-2 max-h-80 overflow-y-auto"></div><button id="save-student-attendance-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Save Attendance</button></div></div>
    </script>
    
    <script>
        // --- LOCAL DATABASE SIMULATION & INITIALIZATION ---
        let currentUser = null;
        let calendar = null;
        let activeLoginRole = null;
        let workloadChart = null;
        let db = {};

        const initialDB = {
            users: {
                'kashy@acadexa.com': { id: 'kashy@acadexa.com', fullName: 'Kashy', role: 'staff', password: 'password123' },
                'anna@acadexa.com': { id: 'anna@acadexa.com', fullName: 'Anna', role: 'staff', password: 'password123' },
                'mike@acadexa.com': { id: 'mike@acadexa.com', fullName: 'Mike', role: 'staff', password: 'password123' },
                'sara@acadexa.com': { id: 'sara@acadexa.com', fullName: 'Sara', role: 'staff', password: 'password123' },
                'leo@acadexa.com': { id: 'leo@acadexa.com', fullName: 'Leo', role: 'staff', password: 'password123' },
                'nina@acadexa.com': { id: 'nina@acadexa.com', fullName: 'Nina', role: 'staff', password: 'password123' },
                'raj@acadexa.com': { id: 'raj@acadexa.com', fullName: 'Raj', role: 'staff', password: 'password123' },
                'yokesh@acadexa.com': { id: 'yokesh@acadexa.com', fullName: 'Yokesh', role: 'student', password: 'student123', scheduleId: 'grade-10-a' }
            },
            schedules: {
                'grade-10-a': {
                    name: 'Grade 10 - Section A',
                    events: {
                        'evt1': { id: 'evt1', title: 'Physics', prof: 'Kashy', room: 'Lab A', credits: 4, start: '2025-10-06T09:00:00', end: '2025-10-06T10:00:00', backgroundColor: '#3b82f6', notes: 'Chapter 3: Motion and Force. Pre-read required.' },
                        'evt2': { id: 'evt2', title: 'Chemistry', prof: 'Anna', room: 'Lab B', credits: 4, start: '2025-10-06T10:00:00', end: '2025-10-06T11:00:00', backgroundColor: '#8b5cf6', notes: 'Experiment on titration. Bring lab coats.' },
                        'evt3': { id: 'evt3', title: 'Math', prof: 'Mike', room: '101', credits: 5, start: '2025-10-06T11:00:00', end: '2025-10-06T12:00:00', backgroundColor: '#ef4444', notes: 'Topic: Advanced Algebra. Homework due.' },
                        'evt4': { id: 'evt4', title: 'English', prof: 'Sara', room: '102', credits: 3, start: '2025-10-07T09:00:00', end: '2025-10-07T10:00:00', backgroundColor: '#10b981', notes: 'Shakespeare\'s Macbeth, Act 2 analysis.' },
                        'evt5': { id: 'evt5', title: 'History', prof: 'Leo', room: '102', credits: 3, start: '2025-10-08T14:00:00', end: '2025-10-08T15:00:00', backgroundColor: '#f97316', notes: 'The French Revolution.' }
                    }
                },
                'grade-11-b': {
                    name: 'Grade 11 - Section B',
                    events: {
                        'evt6': { id: 'evt6', title: 'Biology', prof: 'Nina', room: 'Lab C', credits: 4, start: '2025-10-06T10:00:00', end: '2025-10-06T11:00:00', backgroundColor: '#14b8a6', notes: 'Cellular Biology dissection.' },
                        'evt7': { id: 'evt7', title: 'Computer Sci', prof: 'Raj', room: 'CS Lab', credits: 4, start: '2025-10-07T11:00:00', end: '2025-10-07T12:00:00', backgroundColor: '#64748b', notes: 'Introduction to Python data structures.' }
                    }
                }
            },
            staffAttendance: {},
            studentAttendance: {
                'yokesh@acadexa.com': {}
            },
            classDebts: [],
            availableSubjects: [
                { title: 'Geography', prof: 'Leo', room: '103', credits: 3, backgroundColor: '#f59e0b' },
                { title: 'Art', prof: 'Nina', room: 'Art Room', credits: 2, backgroundColor: '#d946ef' },
                { title: 'Music', prof: 'Sara', room: 'Music Room', credits: 2, backgroundColor: '#0ea5e9' },
                { title: 'Economics', prof: 'Mike', room: '101', credits: 3, backgroundColor: '#22c55e'},
                { title: 'Physical Ed.', prof: 'Kashy', room: 'Gym', credits: 2, backgroundColor: '#f43f5e'}
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modals-container').innerHTML = document.getElementById('modals-template').innerHTML;
            lucide.createIcons();
            loadDatabase();
            setupEventListeners();
            initializeCalendar();
            checkLoginState();
        });

        function loadDatabase() {
            const savedDB = localStorage.getItem('acadexaDB');
            db = savedDB ? JSON.parse(savedDB) : JSON.parse(JSON.stringify(initialDB));
            saveDatabase();
        }
        function saveDatabase() { localStorage.setItem('acadexaDB', JSON.stringify(db)); }

        function checkLoginState() {
            const loggedInUserId = sessionStorage.getItem('acadexaUser');
            currentUser = loggedInUserId && db.users[loggedInUserId] ? db.users[loggedInUserId] : null;
            initializeAppUI(!!currentUser);
        }

        function initializeAppUI(isLoggedIn) {
            updateHeaderUI(isLoggedIn);
            document.getElementById('welcome-screen').classList.toggle('hidden', isLoggedIn);
            document.getElementById('app-wrapper').classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                const isStaff = currentUser.role === 'staff';
                document.getElementById('staff-dashboard').classList.toggle('hidden', !isStaff);
                document.getElementById('student-dashboard').classList.toggle('hidden', isStaff);
                document.getElementById('staff-schedule-tools').classList.toggle('hidden', !isStaff);

                if(isStaff) { renderStaffDashboard(); renderAvailableSubjects(); } else { renderStudentDashboard(); }
                
                populateScheduleSelector();
                const defaultSchedule = !isStaff ? currentUser.scheduleId : Object.keys(db.schedules)[0];
                loadSchedule(defaultSchedule);
                updateNotifications();
            } else {
                hideAllModals();
            }
        }
        
        function updateHeaderUI(isLoggedIn) {
            document.getElementById('auth-container').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('user-info-container').style.display = isLoggedIn ? 'flex' : 'none';
            if(isLoggedIn) document.getElementById('username-display').textContent = currentUser.fullName;
            document.getElementById('ask-ai-btn').style.display = isLoggedIn ? 'flex' : 'none';
            document.getElementById('notifications-btn').style.display = isLoggedIn && currentUser.role === 'staff' ? 'flex' : 'none';
            document.getElementById('staff-schedule-filters').style.display = isLoggedIn && currentUser.role === 'staff' ? 'flex' : 'none';
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('student-login-btn').onclick = () => openLoginModal('student');
            document.getElementById('staff-portal-btn').onclick = () => currentUser?.role === 'staff' ? showModal('staff-portal-modal') : openLoginModal('staff');
            document.getElementById('open-dashboard-btn').onclick = () => { hideModal('staff-portal-modal'); initializeAppUI(true); };
            document.getElementById('open-attendance-portal-btn').onclick = () => { hideModal('staff-portal-modal'); openAttendancePortal(); };
            document.getElementById('logout-btn').onclick = handleLogout;
            document.getElementById('auth-form').onsubmit = handleAuthSubmit;
            document.getElementById('scan-biometric-btn').onclick = handleBiometricScan;
            document.getElementById('ask-ai-btn').onclick = () => showModal('ai-chat-modal');
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
            document.getElementById('notifications-btn').onclick = openNotifications;
            document.getElementById('dark-mode-toggle').onclick = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                document.querySelector('#dark-mode-toggle i').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
                if(workloadChart) renderStaffDashboard();
            };
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                document.querySelector('#dark-mode-toggle i').setAttribute('data-lucide', 'sun');
            }

            document.getElementById('schedule-selector').onchange = (e) => loadSchedule(e.target.value);
            document.getElementById('staff-view-selector').onchange = renderCalendar;
            document.getElementById('heatmap-toggle').onchange = toggleHeatmap;
            document.getElementById('print-btn').onclick = () => window.print();
            document.getElementById('download-btn').onclick = downloadScheduleICS;
            document.addEventListener('click', (e) => {
                 if (e.target.closest('.close-modal-btn')) hideModal(e.target.closest('.modal').id);
                 if (e.target.closest('.repay-debt-btn')) repayDebt(e.target.closest('.repay-debt-btn').dataset.id);
                 if (e.target.closest('.cover-class-btn')) confirmRepayment(e.target.closest('.cover-class-btn').dataset.debtid, e.target.closest('.cover-class-btn').dataset.eventid);
            });
        }
        
        // --- AUTHENTICATION & CORE APP FLOW ---
        function openLoginModal(role) {
            activeLoginRole = role;
            document.getElementById('login-title').textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            showModal('login-modal');
        }
        
        function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            const user = db.users[email];

            if (user && user.password === password && user.role === activeLoginRole) {
                sessionStorage.setItem('acadexaUser', user.id);
                checkLoginState();
                hideModal('login-modal');
            } else {
                errorEl.textContent = "Invalid credentials for this role.";
            }
        }
        
        function handleLogout() {
            sessionStorage.removeItem('acadexaUser');
            checkLoginState();
        }

        // --- DASHBOARDS ---
        function renderStaffDashboard() {
            const dash = document.getElementById('staff-dashboard');
            dash.innerHTML = `<h2 class="text-3xl font-bold mb-6 font-poppins">Staff Dashboard</h2>
                <div class="mb-6 bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4">Admin Controls</h3>
                    <div class="flex flex-wrap gap-2">
                         <button id="auto-schedule-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center gap-2"><i data-lucide="sparkles"></i> Auto-Schedule Subjects</button>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4">Weekly Class Load & Credit Distribution</h3>
                    <canvas id="workload-chart"></canvas>
                </div>`; 
            lucide.createIcons();
            document.getElementById('auto-schedule-btn').onclick = handleAutoSchedule;

            const staffWorkload = {}, staffCredits = {};
            Object.values(db.users).filter(u => u.role === 'staff').forEach(s => { staffWorkload[s.fullName] = 0; staffCredits[s.fullName] = 0; });
            Object.values(db.schedules).forEach(sc => Object.values(sc.events).forEach(ev => {
                if(staffWorkload.hasOwnProperty(ev.prof)) { staffWorkload[ev.prof]++; staffCredits[ev.prof] += ev.credits; }
            }));

            if (workloadChart) workloadChart.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            workloadChart = new Chart(document.getElementById('workload-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(staffWorkload),
                    datasets: [
                        { label: 'Classes', data: Object.values(staffWorkload), backgroundColor: '#4f46e5' },
                        { label: 'Credits', data: Object.values(staffCredits), backgroundColor: '#8b5cf6' }
                    ]
                },
                options: { 
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: isDark ? '#cbd5e1' : '#475569' }, grid: { color: isDark ? '#374151' : '#e2e8f0' } },
                        x: { ticks: { color: isDark ? '#cbd5e1' : '#475569' }, grid: { color: 'transparent' } }
                    },
                    plugins: { legend: { labels: { color: isDark ? '#cbd5e1' : '#475569' } } }
                }
            });
        }

        function renderStudentDashboard() {
            const dash = document.getElementById('student-dashboard');
            const myAttendance = db.studentAttendance[currentUser.id] || {};
            const total = Object.keys(myAttendance).length, attended = Object.values(myAttendance).filter(s => s === 'Present').length;
            const percentage = total > 0 ? ((attended / total) * 100).toFixed(1) : 100;
            const missedHtml = Object.entries(myAttendance).filter(([, s]) => s === 'Absent').map(([id]) => {
                for (const sc of Object.values(db.schedules)) if(sc.events[id]) return `<div class="p-3 bg-slate-100 dark:bg-gray-700 rounded-md"><p class="font-semibold">${sc.events[id].title} with ${sc.events[id].prof}</p><p class="text-sm text-slate-500">${new Date(sc.events[id].start).toLocaleString()}</p><div class="mt-2 text-sm p-2 bg-slate-200 dark:bg-gray-600 rounded"><h5 class="font-bold">Notes:</h5><p>${sc.events[id].notes || 'N/A'}</p></div></div>`;
                return '';
            }).join('') || '<p class="text-slate-500">No missed classes. Great job!</p>';

            dash.innerHTML = `<h2 class="text-3xl font-bold mb-6 font-poppins">Student Dashboard</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md text-center"><h3 class="font-bold text-lg mb-2">Overall Attendance</h3><p class="text-5xl font-bold text-indigo-500">${percentage}%</p></div><div class="md:col-span-2 bg-white dark:bg-gray-800/50 p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">Notes from Missed Classes</h3><div class="space-y-3 max-h-64 overflow-y-auto pr-2">${missedHtml}</div></div></div>`;
        }
        
        // --- ATTENDANCE & BIOMETRICS ---
        function openAttendancePortal() { /* ... function content from user code ... */ }
        function handleLatecomers(todayStr) { /* ... function content from user code ... */ }
        function renderAttendanceDashboard(todayStr) { /* ... function content from user code ... */ }
        function handleBiometricScan() { /* ... function content from user code ... */ }
        function handleAbsence(staffName, auto = false) { /* ... function content from user code ... */ }

        // --- CALENDAR, SCHEDULING, & AUTOMATION ---
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar-container');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
                slotMinTime: '08:00:00', slotMaxTime: '18:00:00', slotDuration: '01:00:00', allDaySlot: false,
                editable: () => currentUser?.role === 'staff', droppable: true,
                eventClick: handleEventClick, eventDrop: handleEventDrop, drop: handleExternalDrop
            });
            calendar.render();
        }

        function loadSchedule(scheduleId) {
            document.getElementById('schedule-selector').value = scheduleId;
            document.getElementById('schedule-view').classList.remove('hidden');
            renderCalendar();
        }

        function renderCalendar() {
            if (!calendar) return;
            const scheduleId = document.getElementById('schedule-selector').value, schedule = db.schedules[scheduleId];
            if (!schedule) return;
            let events = Object.values(schedule.events);
            if(currentUser?.role === 'staff') {
                const viewAs = document.getElementById('staff-view-selector').value;
                if (viewAs !== 'full-class') events = events.filter(e => e.prof === viewAs);
            }
            const todayStr = new Date().toISOString().slice(0, 10), todayAttendance = db.staffAttendance[todayStr] || {};
            const processed = events.map(event => new Date(event.start).toISOString().slice(0, 10) === todayStr && todayAttendance[event.prof] === 'Absent' ? { ...event, classNames: ['absent'], title: `${event.title} (Absent)` } : event);
            calendar.removeAllEvents();
            calendar.addEventSource(processed);
        }
        
        function populateScheduleSelector() {
            const selector = document.getElementById('schedule-selector');
            selector.innerHTML = Object.entries(db.schedules).map(([id, data]) => `<option value="${id}">${data.name}</option>`).join('');
            if(currentUser?.role === 'staff') {
                const staffSelector = document.getElementById('staff-view-selector');
                const staffOptions = Object.values(db.users).filter(u => u.role === 'staff').map(s => `<option value="${s.fullName}">${s.fullName} (Personal)</option>`).join('');
                staffSelector.innerHTML = `<option value="full-class">Full Class View</option>${staffOptions}`;
                staffSelector.value = currentUser.fullName;
            }
        }
        
        function handleEventClick(info) { /* ... function content from user code ... */ }
        function handleEventDrop(info) { /* ... function content from user code ... */ }
        function handleExternalDrop(info) { /* ... function content from user code ... */ }
        function findNextAvailableSlot(scheduleId, afterDate) { /* ... function content from user code ... */ }
        
        function openStudentAttendanceModal(eventId) { /* ... function content from user code ... */ }
        function saveStudentAttendance(eventId) { /* ... function content from user code ... */ }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function handleAutoSchedule() {
            if (currentUser?.role !== 'staff') { showToast("Only staff can auto-schedule.", "error"); return; }
            const subjectsToSchedule = [...db.availableSubjects];
            if (subjectsToSchedule.length === 0) { showToast("No available subjects to schedule.", "info"); return; }

            const scheduleId = document.getElementById('schedule-selector').value;
            const schedule = db.schedules[scheduleId];
            
            const timeSlots = [];
            for (let day = 1; day <= 5; day++) for (let hour = 9; hour <= 16; hour++) timeSlots.push({ day, hour });
            shuffleArray(timeSlots);

            const bookedSlots = new Set(Object.values(schedule.events).map(e => `${new Date(e.start).getDay()}-${new Date(e.start).getHours()}`));
            let placedCount = 0;
            const remainingSubjects = [];

            for (const subject of subjectsToSchedule) {
                let wasPlaced = false;
                for (const slot of timeSlots) {
                    const slotKey = `${slot.day}-${slot.hour}`;
                    if (!bookedSlots.has(slotKey)) {
                        const startDate = new Date(calendar.getDate());
                        startDate.setDate(startDate.getDate() - startDate.getDay() + slot.day);
                        startDate.setHours(slot.hour, 0, 0, 0);
                        
                        schedule.events[`evt_${Date.now()}`] = { ...subject, id: `evt_${Date.now()}`, start: startDate.toISOString(), end: new Date(startDate.getTime() + 60*60*1000).toISOString() };
                        bookedSlots.add(slotKey);
                        wasPlaced = true;
                        placedCount++;
                        break;
                    }
                }
                if (!wasPlaced) remainingSubjects.push(subject);
            }
            db.availableSubjects = remainingSubjects;
            saveDatabase();
            renderAvailableSubjects();
            renderCalendar();
            showToast(`Auto-scheduled ${placedCount} subjects!`, 'success');
        }

        function toggleHeatmap(event) {
            const calendarEl = document.getElementById('calendar-container');
            calendarEl.querySelectorAll('.fc-timegrid-slot').forEach(slot => slot.classList.remove('heatmap-1', 'heatmap-2'));
            if (!event.target.checked) return;

            const counts = {};
            calendar.getEvents().forEach(event => {
                const key = `${event.start.getDay()}-${event.start.getHours()}`;
                counts[key] = (counts[key] || 0) + 1;
            });
            
            calendarEl.querySelectorAll('.fc-timegrid-slot').forEach(slot => {
                const time = slot.dataset.time, dayEl = slot.closest('.fc-timegrid-col');
                if (!time || !dayEl) return;
                const hour = parseInt(time.split(':')[0]), day = Array.from(dayEl.parentElement.children).indexOf(dayEl);
                const count = counts[`${day}-${hour}`];
                if (count) slot.classList.add(`heatmap-${Math.min(count, 2)}`);
            });
        }
        
        // --- DEBTS & NOTIFICATIONS ---
        function createClassDebt(debtorName, classInfo) { /* ... function content from user code ... */ }
        function updateNotifications() { /* ... function content from user code ... */ }
        function openNotifications() { /* ... function content from user code ... */ }
        function repayDebt(debtId) { /* ... function content from user code ... */ }
        function confirmRepayment(debtId, originalEventId) { /* ... function content from user code ... */ }

        // --- AI CHATBOT "ACADEXI" ---
        let chatState = {};
        function resetChatState() { chatState = { active: false, stage: null, collected: {} }; }
        resetChatState();

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input'), query = input.value.trim();
            if (!query) return;
            addChatMessage(query, 'user');
            input.value = '';

            const lowerQuery = query.toLowerCase();

            if (lowerQuery.includes('cancel')) {
                resetChatState();
                addChatMessage("OK, I've cancelled the request. How else can I help?", 'bot');
                return;
            }

            if (!chatState.active) {
                if (lowerQuery.includes('schedule')) {
                    chatState.active = true;
                    chatState.stage = 'subject';
                    addChatMessage("Great! Which subject would you like to schedule? (e.g., Physics)", 'bot');
                } else {
                    addChatMessage("I can help with scheduling. Try 'schedule a class'.", 'bot');
                }
                return;
            }

            switch(chatState.stage) {
                case 'subject':
                    chatState.collected.title = query;
                    chatState.stage = 'prof';
                    addChatMessage(`Got it. Which professor?`, 'bot');
                    break;
                case 'prof':
                    chatState.collected.prof = query;
                    chatState.stage = 'room';
                    addChatMessage(`OK. And in which room?`, 'bot');
                    break;
                case 'room':
                    chatState.collected.room = query;
                    chatState.stage = 'day';
                    addChatMessage(`Perfect. On which day? (e.g., Monday)`, 'bot');
                    break;
                case 'day':
                    const dayMap = { 'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6 };
                    if (dayMap[lowerQuery] === undefined) { addChatMessage("Please provide a valid day of the week.", 'bot'); return; }
                    chatState.collected.day = dayMap[lowerQuery];
                    chatState.stage = 'time';
                    addChatMessage(`Finally, at what time? (e.g., 10am, 2:30pm)`, 'bot');
                    break;
                case 'time':
                    const timeMatch = lowerQuery.match(/(\d{1,2})(?::(\d{2}))?(am|pm)?/);
                    if (!timeMatch) { addChatMessage("Sorry, I don't recognize that time. Try a format like '2pm' or '14:30'.", 'bot'); return; }
                    let hour = parseInt(timeMatch[1]);
                    if (timeMatch[3] === 'pm' && hour < 12) hour += 12;
                    if (timeMatch[3] === 'am' && hour === 12) hour = 0;
                    
                    const scheduleId = document.getElementById('schedule-selector').value;
                    const startDate = new Date(calendar.getDate());
                    startDate.setDate(startDate.getDate() - startDate.getDay() + chatState.collected.day);
                    startDate.setHours(hour, parseInt(timeMatch[2] || '0'), 0, 0);

                    const newEvent = { ...chatState.collected, id: `evt_${Date.now()}`, start: startDate.toISOString(), end: new Date(startDate.getTime() + 60*60*1000).toISOString(), backgroundColor: '#0ea5e9', credits: 3 };
                    db.schedules[scheduleId].events[newEvent.id] = newEvent;
                    saveDatabase();
                    renderCalendar();
                    addChatMessage(`All set! I've scheduled ${newEvent.title} on the calendar for you.`, 'bot');
                    resetChatState();
                    break;
            }
        }
        
        function addChatMessage(message, sender) { /* ... function content from user code ... */ }
        function getAcaDexiResponse(query) { /* Replaced by conversational logic */ }

        // --- UTILITIES ---
        function showModal(id) { document.getElementById(id)?.classList.add('visible'); }
        function hideModal(id) { document.getElementById(id)?.classList.remove('visible'); }
        function hideAllModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('visible')); }
        let toastTimeout;
        function showToast(message, type = "info", duration = 3000) { /* ... function content from user code ... */ }
        function renderAvailableSubjects() { /* ... function content from user code ... */ }
        function downloadScheduleICS() { /* ... function content from user code ... */ }
    </script>
</body>
</html>
